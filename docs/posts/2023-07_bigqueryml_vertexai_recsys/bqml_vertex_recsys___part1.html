<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Francisco Mussari">
<meta name="dcterms.date" content="2023-07-17">

<title>datamatica - RecSys MLOps. BigQuery ML and Vertex AI. Part 1</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">datamatica</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/fmussari" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/francisco-mussari-432b781a6/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">RecSys MLOps. BigQuery ML and Vertex AI. Part 1</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Movielens</div>
                <div class="quarto-category">BigQuery</div>
                <div class="quarto-category">BigQuery ML</div>
                <div class="quarto-category">RecSys</div>
                <div class="quarto-category">Recommender</div>
                <div class="quarto-category">Pipeline</div>
                <div class="quarto-category">Vertex AI</div>
                <div class="quarto-category">MLOps</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Francisco Mussari </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 17, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a>
  <ul class="collapse">
  <li><a href="#additional-resources" id="toc-additional-resources" class="nav-link" data-scroll-target="#additional-resources">Additional Resources</a></li>
  </ul></li>
  <li><a href="#blog-post-parts" id="toc-blog-post-parts" class="nav-link" data-scroll-target="#blog-post-parts">Blog Post Parts</a>
  <ul class="collapse">
  <li><a href="#part-1.-train-and-deploy" id="toc-part-1.-train-and-deploy" class="nav-link" data-scroll-target="#part-1.-train-and-deploy">Part 1. Train and Deploy</a></li>
  <li><a href="#part-2.-inference" id="toc-part-2.-inference" class="nav-link" data-scroll-target="#part-2.-inference">Part 2. Inference</a></li>
  </ul></li>
  <li><a href="#before-you-begin" id="toc-before-you-begin" class="nav-link" data-scroll-target="#before-you-begin">Before you begin</a></li>
  <li><a href="#loading-data-into-bigquery" id="toc-loading-data-into-bigquery" class="nav-link" data-scroll-target="#loading-data-into-bigquery">Loading data into BigQuery</a>
  <ul class="collapse">
  <li><a href="#authenticate-your-google-cloud-account" id="toc-authenticate-your-google-cloud-account" class="nav-link" data-scroll-target="#authenticate-your-google-cloud-account">Authenticate your Google Cloud account</a></li>
  <li><a href="#set-your-project-id" id="toc-set-your-project-id" class="nav-link" data-scroll-target="#set-your-project-id">Set your project ID</a></li>
  <li><a href="#download-movielens-1m-movie-ratings-dataset" id="toc-download-movielens-1m-movie-ratings-dataset" class="nav-link" data-scroll-target="#download-movielens-1m-movie-ratings-dataset">Download MovieLens 1M movie ratings dataset</a></li>
  <li><a href="#create-bigquery-datasets-and-populate-the-tables" id="toc-create-bigquery-datasets-and-populate-the-tables" class="nav-link" data-scroll-target="#create-bigquery-datasets-and-populate-the-tables">Create BigQuery datasets and populate the tables</a></li>
  </ul></li>
  <li><a href="#vertex-ai-pipeline.-install-libraries-and-setup-services-and-accounts" id="toc-vertex-ai-pipeline.-install-libraries-and-setup-services-and-accounts" class="nav-link" data-scroll-target="#vertex-ai-pipeline.-install-libraries-and-setup-services-and-accounts">Vertex AI Pipeline. Install Libraries and Setup Services and Accounts</a>
  <ul class="collapse">
  <li><a href="#install-libraries" id="toc-install-libraries" class="nav-link" data-scroll-target="#install-libraries">Install Libraries</a></li>
  <li><a href="#restart-the-kernel" id="toc-restart-the-kernel" class="nav-link" data-scroll-target="#restart-the-kernel">Restart the Kernel</a></li>
  <li><a href="#set-project-variables" id="toc-set-project-variables" class="nav-link" data-scroll-target="#set-project-variables">Set Project Variables</a></li>
  <li><a href="#authenticate-your-google-cloud-account-again" id="toc-authenticate-your-google-cloud-account-again" class="nav-link" data-scroll-target="#authenticate-your-google-cloud-account-again">Authenticate your Google Cloud account (again)</a></li>
  <li><a href="#enable-service-apis" id="toc-enable-service-apis" class="nav-link" data-scroll-target="#enable-service-apis">Enable Service APIs</a></li>
  <li><a href="#create-a-service-account-for-the-pipeline-to-run" id="toc-create-a-service-account-for-the-pipeline-to-run" class="nav-link" data-scroll-target="#create-a-service-account-for-the-pipeline-to-run">Create a Service Account for the pipeline to run</a></li>
  <li><a href="#grant-the-service-account-granular-permissions-to-gcp-resources" id="toc-grant-the-service-account-granular-permissions-to-gcp-resources" class="nav-link" data-scroll-target="#grant-the-service-account-granular-permissions-to-gcp-resources">Grant the Service Account granular permissions to GCP resources</a></li>
  </ul></li>
  <li><a href="#vertex-ai-pipeline---create-and-run-the-pipeline" id="toc-vertex-ai-pipeline---create-and-run-the-pipeline" class="nav-link" data-scroll-target="#vertex-ai-pipeline---create-and-run-the-pipeline">Vertex AI Pipeline - Create and Run the Pipeline</a>
  <ul class="collapse">
  <li><a href="#import-libraries" id="toc-import-libraries" class="nav-link" data-scroll-target="#import-libraries">Import Libraries</a></li>
  <li><a href="#initialize-vertex-ai-sdk-for-python" id="toc-initialize-vertex-ai-sdk-for-python" class="nav-link" data-scroll-target="#initialize-vertex-ai-sdk-for-python">Initialize Vertex AI SDK for Python</a></li>
  <li><a href="#declare-pipeline-components" id="toc-declare-pipeline-components" class="nav-link" data-scroll-target="#declare-pipeline-components">Declare Pipeline Components</a></li>
  <li><a href="#pipeline-and-job" id="toc-pipeline-and-job" class="nav-link" data-scroll-target="#pipeline-and-job">Pipeline and Job</a></li>
  </ul></li>
  <li><a href="#make-sure-no-reservation-or-slot-assignment-is-active" id="toc-make-sure-no-reservation-or-slot-assignment-is-active" class="nav-link" data-scroll-target="#make-sure-no-reservation-or-slot-assignment-is-active">Make sure no reservation or slot assignment is active</a>
  <ul class="collapse">
  <li><a href="#delete-any-reservation-and-assignment" id="toc-delete-any-reservation-and-assignment" class="nav-link" data-scroll-target="#delete-any-reservation-and-assignment">Delete any reservation and assignment</a></li>
  </ul></li>
  <li><a href="#monitor-the-process" id="toc-monitor-the-process" class="nav-link" data-scroll-target="#monitor-the-process">Monitor the process</a></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">Conclusions</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>This post is about training a Matrix Factorization model with BigQuery ML and deploying it as Docker container. The end-to-end process is orchestrated through a Vertex AI pipeline.</p>
<p>The post is strongly based on this tutorial: - <a href="https://youtu.be/S0wNWOR4WoE">YouTube: Recommendation Engine Pipeline with BigQuery ML and Vertex AI Pipelines using Matrix Factorization</a></p>
<p>But there are some key differences:</p>
<ol type="1">
<li>This post documents the whole process, from loading the data into BigQuery to how to make recommendations in different ways.</li>
<li>On July 5th there was a <a href="https://cloud.google.com/bigquery/docs/editions-transition">Transition to BigQuery editions</a> which resulted in some changes being made to adapt the scripts shown in the original video.</li>
<li>When trying to replicate the video tutorial I had to solve some issues with the pipeline failing to run. Most of the issues were very hard to debug, with misleading error messages and layers over layer of abstraction between python libraries and component definitions. At the end most of the errors were about the Default Service Account not having the requiered permission. So,</li>
<li>In this post we can see and run each step and command to create a Service Account and grant this account granular permissions to the Google Cloud resources needed for the end to end process to run. This is what the Google documentation recommends.</li>
<li>There are also the commands to enable each service API needed for the project.</li>
</ol>
<p>At the end we shoud get a flow like this:</p>
<p><img src="pipeline.PNG" class="img-fluid"></p>
<section id="additional-resources" class="level3">
<h3 class="anchored" data-anchor-id="additional-resources">Additional Resources</h3>
<ul>
<li><a href="https://youtu.be/p4ZZq0736Po?t=3720">YouTube: Lesson 7: Practical Deep Learning for Coders 2022 - Collaborative filtering deep dive</a></li>
<li><a href="https://cloud.google.com/bigquery/docs/bigqueryml-mf-implicit-tutorial">Tutorial: Use BigQuery ML to make recommendations from Google analytics data</a></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This notebook is better suited for running in Colab.</p>
</div>
</div>
</section>
</section>
<section id="blog-post-parts" class="level2">
<h2 class="anchored" data-anchor-id="blog-post-parts">Blog Post Parts</h2>
<section id="part-1.-train-and-deploy" class="level3">
<h3 class="anchored" data-anchor-id="part-1.-train-and-deploy">Part 1. Train and Deploy</h3>
<ul>
<li>Loading MovieLens data into BigQuery</li>
<li>Setup services and accounts for the Vertex AI Pipeline to run</li>
<li>Create and run the Pipeline and its Components</li>
<li>Make sure no reservation or slot assignment remains active</li>
</ul>
</section>
<section id="part-2.-inference" class="level3">
<h3 class="anchored" data-anchor-id="part-2.-inference">Part 2. Inference</h3>
<ul>
<li>Use the Cloud Run endpoint to get recommendations</li>
<li>Get recommendations from BigQuery ML</li>
<li>Get Weights and Bias (Embeddings) and do the math</li>
</ul>
</section>
</section>
<section id="before-you-begin" class="level2">
<h2 class="anchored" data-anchor-id="before-you-begin">Before you begin</h2>
<ol type="1">
<li><a href="https://console.cloud.google.com/cloud-resource-manager">Select or create a Google Cloud project</a>.</li>
<li><a href="https://cloud.google.com/billing/docs/how-to/modify-project">Make sure that billing is enabled for your project</a>.</li>
<li>You can run the code locally or in Colab. If you are locally you need to install the <a href="https://cloud.google.com/sdk/docs/install">gcloud CLI</a>.</li>
</ol>
</section>
<section id="loading-data-into-bigquery" class="level2">
<h2 class="anchored" data-anchor-id="loading-data-into-bigquery">Loading data into BigQuery</h2>
<p>Reference: <a href="https://cloud.google.com/bigquery/docs/bigqueryml-mf-explicit-tutorial#step_two_load_the_movielens_dataset_into">Load the Movielens dataset into BigQuery</a></p>
<section id="authenticate-your-google-cloud-account" class="level3">
<h3 class="anchored" data-anchor-id="authenticate-your-google-cloud-account">Authenticate your Google Cloud account</h3>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"google.colab"</span> <span class="kw">in</span> sys.modules:</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    IS_COLAB <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> google.colab <span class="im">import</span> auth <span class="im">as</span> google_auth</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    google_auth.authenticate_user()</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If you are running this notebook locally, replace the string below with the</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># path to your service account key and run this cell to authenticate your GCP</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># account.</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>env GOOGLE_APPLICATION_CREDENTIALS <span class="st">''</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="set-your-project-id" class="level3">
<h3 class="anchored" data-anchor-id="set-your-project-id">Set your project ID</h3>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>PROJECT_ID <span class="op">=</span> <span class="st">"[your-project-id]"</span>  <span class="co"># @param {type:"string"}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="download-movielens-1m-movie-ratings-dataset" class="level3">
<h3 class="anchored" data-anchor-id="download-movielens-1m-movie-ratings-dataset">Download MovieLens 1M movie ratings dataset</h3>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> curl <span class="op">-</span>O <span class="st">'http://files.grouplens.org/datasets/movielens/ml-1m.zip'</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> unzip <span class="op">-</span>o ml<span class="op">-</span><span class="dv">1</span><span class="er">m</span>.<span class="bu">zip</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Change te existing <code>::</code> delimiter to comma and save the files as <code>.csv</code>:</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> sed <span class="st">'s/::/,/g'</span> ml<span class="op">-</span><span class="dv">1</span><span class="er">m</span><span class="op">/</span>ratings.dat <span class="op">&gt;</span> ratings.csv</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> sed <span class="st">'s/::/@/g'</span> ml<span class="op">-</span><span class="dv">1</span><span class="er">m</span><span class="op">/</span>movies.dat <span class="op">&gt;</span> movie_titles.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-bigquery-datasets-and-populate-the-tables" class="level3">
<h3 class="anchored" data-anchor-id="create-bigquery-datasets-and-populate-the-tables">Create BigQuery datasets and populate the tables</h3>
<p>Define the names of the datasets.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>MODEL_DATASET <span class="op">=</span> <span class="st">"[bq-model-dataset]"</span>  <span class="co"># @param {type:"string"}</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>MOVIELENS_DATASET <span class="op">=</span> <span class="st">"[bq-data-dataset]"</span>  <span class="co"># @param {type:"string"}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To store the model</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> bq mk <span class="op">--</span>location<span class="op">=</span>US <span class="op">--</span>dataset {PROJECT_ID}:{MODEL_DATASET}</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># To store movies and reviews tables</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> bq mk <span class="op">--</span>location<span class="op">=</span>US <span class="op">--</span>dataset {PROJECT_ID}:{MOVIELENS_DATASET}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create and populate the tables <code>movielens_1m</code> and <code>movie_titles</code>.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reviews table</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> bq load <span class="op">--</span>project_id<span class="op">=</span>{PROJECT_ID} <span class="op">--</span>source_format<span class="op">=</span>CSV {PROJECT_ID}:{MOVIELENS_DATASET}.movielens_1m ratings.csv user_id:INT64,item_id:INT64,rating:FLOAT64,timestamp:TIMESTAMP</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Movies table</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> bq load <span class="op">--</span>project_id<span class="op">=</span>{PROJECT_ID} <span class="op">--</span>source_format<span class="op">=</span>CSV <span class="op">--</span>field_delimiter<span class="op">=@</span> {PROJECT_ID}:{MOVIELENS_DATASET}.movie_titles movie_titles.csv movie_id:INT64,movie_title:STRING,genre:STRING</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="vertex-ai-pipeline.-install-libraries-and-setup-services-and-accounts" class="level2">
<h2 class="anchored" data-anchor-id="vertex-ai-pipeline.-install-libraries-and-setup-services-and-accounts">Vertex AI Pipeline. Install Libraries and Setup Services and Accounts</h2>
<section id="install-libraries" class="level3">
<h3 class="anchored" data-anchor-id="install-libraries">Install Libraries</h3>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> pip install google<span class="op">-</span>cloud<span class="op">-</span>aiplatform<span class="op">==</span><span class="fl">1.21.0</span> <span class="op">--</span>upgrade</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> pip install kfp<span class="op">==</span><span class="fl">2.0.1</span> <span class="op">--</span>upgrade</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> pip install google<span class="op">-</span>cloud<span class="op">-</span>pipeline<span class="op">-</span>components<span class="op">==</span><span class="fl">2.0.0</span> <span class="op">--</span>upgrade</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="restart-the-kernel" class="level3">
<h3 class="anchored" data-anchor-id="restart-the-kernel">Restart the Kernel</h3>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Automatically restart kernel after installs so that your environment can access the new packages</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> IPython</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> IPython.Application.instance()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>app.kernel.do_shutdown(<span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="set-project-variables" class="level3">
<h3 class="anchored" data-anchor-id="set-project-variables">Set Project Variables</h3>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>PROJECT_ID <span class="op">=</span> <span class="st">"[your-project-id]"</span>  <span class="co"># @param {type:"string"}</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>REGION <span class="op">=</span> <span class="st">"us-central1"</span>              <span class="co"># @param {type: "string"}</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>BUCKET_NAME <span class="op">=</span> <span class="st">"[pipeline-bucket]"</span> <span class="co"># @param {type: "string"}</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>PIPELINE_ROOT <span class="op">=</span> <span class="ss">f"gs://</span><span class="sc">{</span>BUCKET_NAME<span class="sc">}</span><span class="ss">/"</span>   </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>MODEL_DIR <span class="op">=</span> PIPELINE_ROOT <span class="op">+</span> <span class="st">"recommender_model"</span>    <span class="co"># @param {type: "string"}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="authenticate-your-google-cloud-account-again" class="level3">
<h3 class="anchored" data-anchor-id="authenticate-your-google-cloud-account-again">Authenticate your Google Cloud account (again)</h3>
<p>Since the kernel was restarted, authenticate again.</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"google.colab"</span> <span class="kw">in</span> sys.modules:</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    IS_COLAB <span class="op">=</span> <span class="va">True</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> google.colab <span class="im">import</span> auth <span class="im">as</span> google_auth</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    google_auth.authenticate_user()</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If you are running this notebook locally, replace the string below with the</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># path to your service account key and run this cell to authenticate your GCP</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># account.</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>env GOOGLE_APPLICATION_CREDENTIALS <span class="op">&lt;</span>path<span class="op">-</span>to<span class="op">-</span>json<span class="op">-</span>credential<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> gcloud config <span class="bu">set</span> project {PROJECT_ID}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="enable-service-apis" class="level3">
<h3 class="anchored" data-anchor-id="enable-service-apis">Enable Service APIs</h3>
<p>Enabling the APIs with commands instead of doing it in the UI keeps everythong documented. For this project the following services are needed: - Identity and Access Management (IAM) API - Vertex AI API - Cloud Build API - BigQuery API (Although this should be enabled already if the datasets were created and the tables populated) - BigQuery Reservation API - Cloud Run Admin API - Cloud Storage API</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> gcloud services enable iam.googleapis.com <span class="op">--</span>project<span class="op">=</span>{PROJECT_ID}</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> gcloud services enable aiplatform.googleapis.com <span class="op">--</span>project<span class="op">=</span>{PROJECT_ID}</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> gcloud services enable cloudbuild.googleapis.com <span class="op">--</span>project<span class="op">=</span>{PROJECT_ID}</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> gcloud services enable bigquery.googleapis.com <span class="op">--</span>project<span class="op">=</span>{PROJECT_ID}</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> gcloud services enable bigqueryreservation.googleapis.com <span class="op">--</span>project<span class="op">=</span>{PROJECT_ID}</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> gcloud services enable run.googleapis.com <span class="op">--</span>project<span class="op">=</span>{PROJECT_ID}</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> gcloud services enable storage<span class="op">-</span>component.googleapis.com <span class="op">--</span>project<span class="op">=</span>{PROJECT_ID}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-a-service-account-for-the-pipeline-to-run" class="level3">
<h3 class="anchored" data-anchor-id="create-a-service-account-for-the-pipeline-to-run">Create a Service Account for the pipeline to run</h3>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>SERVICE_ACCOUNT_ID <span class="op">=</span> <span class="st">"[your-service-account-id]"</span>  <span class="co"># @param {type:"string"}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If the following cell returns an error in Colab, run it in your local machine. Or create the account directly in the Google Cloud Console UI.</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> gcloud iam service<span class="op">-</span>accounts create {SERVICE_ACCOUNT_ID} <span class="op">--</span>description<span class="op">=</span><span class="st">"Vertex AI Pipeline Service Account"</span> <span class="op">--</span>display<span class="op">-</span>name<span class="op">=</span><span class="st">"vertex_service_account"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>SERVICE_ACCOUNT <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>SERVICE_ACCOUNT_ID<span class="sc">}</span><span class="ss">@</span><span class="sc">{</span>PROJECT_ID<span class="sc">}</span><span class="ss">.iam.gserviceaccount.com"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="if-not-use-the-default-service-account-instead" class="level4">
<h4 class="anchored" data-anchor-id="if-not-use-the-default-service-account-instead">If not, use the Default Service Account instead</h4>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>shell_output <span class="op">=</span> <span class="op">!</span> gcloud projects describe {PROJECT_ID}</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>PROJECT_NUMBER <span class="op">=</span> shell_output[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">":"</span>)[<span class="dv">1</span>].strip().replace(<span class="st">"'"</span>, <span class="st">""</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>DEFAULT_SERVICE_ACCOUNT <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>PROJECT_NUMBER<span class="sc">}</span><span class="ss">-compute@developer.gserviceaccount.com"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>IS_COLAB <span class="op">=</span> <span class="st">"google.colab"</span> <span class="kw">in</span> sys.modules</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    SERVICE_ACCOUNT_ID <span class="op">==</span> <span class="st">""</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">or</span> SERVICE_ACCOUNT_ID <span class="kw">is</span> <span class="va">None</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">or</span> SERVICE_ACCOUNT_ID <span class="op">==</span> <span class="st">"[your-service-account-id]"</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get your service account from gcloud</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> IS_COLAB:</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        shell_output <span class="op">=</span> <span class="op">!</span>gcloud auth <span class="bu">list</span> <span class="dv">2</span><span class="op">&gt;/</span>dev<span class="op">/</span>null</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        DEFAULT_SERVICE_ACCOUNT <span class="op">=</span> shell_output[<span class="dv">2</span>].replace(<span class="st">"*"</span>, <span class="st">""</span>).strip()</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> IS_COLAB:</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        shell_output <span class="op">=</span> <span class="op">!</span> gcloud projects describe {PROJECT_ID}</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        PROJECT_NUMBER <span class="op">=</span> shell_output[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">":"</span>)[<span class="dv">1</span>].strip().replace(<span class="st">"'"</span>, <span class="st">""</span>)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>        DEFAULT_SERVICE_ACCOUNT <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>PROJECT_NUMBER<span class="sc">}</span><span class="ss">-compute@developer.gserviceaccount.com"</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Service Account:"</span>, DEFAULT_SERVICE_ACCOUNT)</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    SERVICE_ACCOUNT <span class="op">=</span> DEFAULT_SERVICE_ACCOUNT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="grant-the-service-account-granular-permissions-to-gcp-resources" class="level3">
<h3 class="anchored" data-anchor-id="grant-the-service-account-granular-permissions-to-gcp-resources">Grant the Service Account granular permissions to GCP resources</h3>
<p>The most challenging part of the project was figuring out how to give the service account the right granular permissions. I didn’t want to give the service account the Editor or Owner rol. It took me a while to find the right roles. As I mentioned some errors in the pipeline were because lack of permissions, but it was hard to troubleshoot as there wasn’t any mention to the actual rol needed.</p>
<section id="grant-aiplatform.user-rol" class="level4">
<h4 class="anchored" data-anchor-id="grant-aiplatform.user-rol">Grant <code>aiplatform.user</code> rol</h4>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>service_arg <span class="op">=</span> <span class="ss">f"serviceAccount:</span><span class="sc">{</span>SERVICE_ACCOUNT<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> gcloud projects add<span class="op">-</span>iam<span class="op">-</span>policy<span class="op">-</span>binding {PROJECT_ID} <span class="op">--</span>member<span class="op">=</span>{service_arg} <span class="op">--</span>role<span class="op">=</span><span class="st">"roles/aiplatform.user"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-the-gcs-bucket-and-assign-storage.objectadmin-rol" class="level4">
<h4 class="anchored" data-anchor-id="create-the-gcs-bucket-and-assign-storage.objectadmin-rol">Create the GCS bucket and assign <code>storage.objectAdmin</code> rol</h4>
<p>I first assigned <code>storage.objectCreator</code> and <code>objectViewer</code> roles. Took me hours to find out that the trained model couldn’t be exported without the rol of <code>storage.objectAdmin</code>, which is needed to modify existing data in the bucket.</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> gsutil mb <span class="op">-</span>p {PROJECT_ID} <span class="op">-</span>l {REGION} {PIPELINE_ROOT}</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> gsutil iam ch serviceAccount:{SERVICE_ACCOUNT}:roles<span class="op">/</span>storage.objectAdmin {PIPELINE_ROOT}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="cloud-runs-run.developer-rol" class="level4">
<h4 class="anchored" data-anchor-id="cloud-runs-run.developer-rol">Cloud Run’s <code>run.developer</code> rol</h4>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> gcloud projects add<span class="op">-</span>iam<span class="op">-</span>policy<span class="op">-</span>binding {PROJECT_ID} <span class="op">--</span>member<span class="op">=</span>{service_arg} <span class="op">--</span>role<span class="op">=</span><span class="st">"roles/run.developer"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="cloud-builds-cloudbuild.builds.editor-rol" class="level4">
<h4 class="anchored" data-anchor-id="cloud-builds-cloudbuild.builds.editor-rol">Cloud Build’s <code>cloudbuild.builds.editor</code> rol</h4>
<p>I thought that Cloud Run developer rol was enough for the model to be deployed. Took me a while to find out the service account needed a permission from Cloud Build service also.</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> gcloud projects add<span class="op">-</span>iam<span class="op">-</span>policy<span class="op">-</span>binding {PROJECT_ID} <span class="op">--</span>member<span class="op">=</span>{service_arg} <span class="op">--</span>role<span class="op">=</span><span class="st">"roles/cloudbuild.builds.editor"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="assign-roles-to-cloud-builds-service-account" class="level4">
<h4 class="anchored" data-anchor-id="assign-roles-to-cloud-builds-service-account">Assign roles to Cloud Build’s service account</h4>
<p>When Cloud Build’s API is enabled, its service account is automatically created.</p>
<blockquote class="blockquote">
<p>By default – for security reasons – the Cloud Build Service Account does not have the permissions to manage Cloud Run. <a href="https://www.bram.us/2020/02/13/google-cloud-build-google-cloud-run-fixing-error-gcloud-run-deploy-permission_denied-the-caller-does-not-have-permission/">Google Cloud Build + Google Cloud Run</a></p>
</blockquote>
<p>First lets grab the default Cloud Build and Compute Engine service accounts.</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cloud Build default service account</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>cloud_build_sa <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>PROJECT_NUMBER<span class="sc">}</span><span class="ss">@cloudbuild.gserviceaccount.com"</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>service_build_arg <span class="op">=</span> <span class="ss">f"serviceAccount:</span><span class="sc">{</span>cloud_build_sa<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute Engine default service account</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>compute_engine_sa <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>PROJECT_NUMBER<span class="sc">}</span><span class="ss">-compute@developer.gserviceaccount.com"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> gcloud projects add<span class="op">-</span>iam<span class="op">-</span>policy<span class="op">-</span>binding {PROJECT_ID} <span class="op">--</span>member<span class="op">=</span>{service_build_arg} <span class="op">--</span>role<span class="op">=</span><span class="st">"roles/run.admin"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And the last part was to “<a href="https://www.bram.us/2020/02/13/google-cloud-build-google-cloud-run-fixing-error-gcloud-run-deploy-permission_denied-the-caller-does-not-have-permission/">Grant the IAM Service Account User role to the Cloud Build service account on the Cloud Run runtime service account</a>”.</p>
<p>Meaning that Cloud Build service account is going to be able to impersonate Cloud Run runtime service account, which is Compute Engine default service account. More on impersonation here: <a href="https://youtu.be/pHdQ13HSCq8">Youtube: Service Account Impersonation in Google Cloud - IAM in GCP</a></p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> gcloud iam service<span class="op">-</span>accounts add<span class="op">-</span>iam<span class="op">-</span>policy<span class="op">-</span>binding {compute_engine_sa} <span class="op">--</span>member<span class="op">=</span>{service_build_arg} <span class="op">--</span>role<span class="op">=</span><span class="st">"roles/iam.serviceAccountUser"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And that’s it, all services are enabled and the service accounts has the granular permission for the pipeline to run.</p>
</section>
</section>
</section>
<section id="vertex-ai-pipeline---create-and-run-the-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="vertex-ai-pipeline---create-and-run-the-pipeline">Vertex AI Pipeline - Create and Run the Pipeline</h2>
<section id="import-libraries" class="level3">
<h3 class="anchored" data-anchor-id="import-libraries">Import Libraries</h3>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> kfp</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> NamedTuple</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> kfp.dsl <span class="im">import</span> (</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    pipeline, component, OutputPath, InputPath, Model, </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    Input, Artifact, Output, Metrics</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> kfp <span class="im">import</span> compiler</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.cloud <span class="im">import</span> aiplatform</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.cloud.aiplatform <span class="im">import</span> pipeline_jobs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="initialize-vertex-ai-sdk-for-python" class="level3">
<h3 class="anchored" data-anchor-id="initialize-vertex-ai-sdk-for-python">Initialize Vertex AI SDK for Python</h3>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>aiplatform.init(project<span class="op">=</span>PROJECT_ID, location<span class="op">=</span>REGION)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="declare-pipeline-components" class="level3">
<h3 class="anchored" data-anchor-id="declare-pipeline-components">Declare Pipeline Components</h3>
<section id="create-bigquery-reservation-component" class="level4">
<h4 class="anchored" data-anchor-id="create-bigquery-reservation-component">Create BigQuery Reservation Component</h4>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="at">@component</span>(packages_to_install<span class="op">=</span>[<span class="st">"google-cloud-bigquery-reservation==1.11.2"</span>])</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_reservation(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    project: <span class="bu">str</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    location: <span class="bu">str</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    commitment_slots: <span class="bu">int</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    reservation_id: <span class="bu">str</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> NamedTuple(<span class="st">"outputs"</span>, [(<span class="st">"reservation_name"</span>, <span class="bu">str</span>), (<span class="st">"assignment_name"</span>, <span class="bu">str</span>)]):</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Create BigQuery Reservation and Assignment</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'project'</span>, project, <span class="st">'location'</span>, location, <span class="st">'commitment_slots'</span>, commitment_slots, <span class="st">'reservation_id'</span>, reservation_id)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># import libraries</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> time</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> google.cloud.bigquery_reservation_v1 <span class="im">import</span> (</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>        CapacityCommitment, Reservation, Assignment, ReservationServiceClient</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    reservation_client <span class="op">=</span> ReservationServiceClient()</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    parent_arg <span class="op">=</span> <span class="ss">f"projects/</span><span class="sc">{</span>project<span class="sc">}</span><span class="ss">/locations/</span><span class="sc">{</span>location<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reservation (autoscaling)</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    autosc <span class="op">=</span> Reservation.Autoscale(current_slots<span class="op">=</span><span class="dv">0</span>, max_slots<span class="op">=</span>commitment_slots) <span class="co"># NEW Jul-05 Update</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">#reservation_slots = commitment_slots</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    slot_capacity <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    reservation_config <span class="op">=</span> Reservation(</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">#slot_capacity=reservation_slots,</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>        slot_capacity<span class="op">=</span>slot_capacity, autoscale<span class="op">=</span>autosc,  <span class="co"># NEW Jul-05 Update</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>        edition<span class="op">=</span><span class="st">'ENTERPRISE'</span>,   <span class="co"># NEW Jul-05 Update (Could be "STANDARD" ?)</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>        ignore_idle_slots<span class="op">=</span><span class="va">False</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    reservation <span class="op">=</span> reservation_client.create_reservation(</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>        parent<span class="op">=</span>parent_arg, reservation_id<span class="op">=</span>reservation_id, reservation<span class="op">=</span>reservation_config</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>    reservation_name <span class="op">=</span> reservation.name</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'reservation_name'</span>, reservation_name)</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assignment</span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Creating Assignment..."</span>)</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>    assignment_config <span class="op">=</span> Assignment(</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>        job_type<span class="op">=</span><span class="st">'QUERY'</span>, assignee<span class="op">=</span><span class="st">'projects/</span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(project)</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>    assignment <span class="op">=</span> reservation_client.create_assignment(</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>        parent<span class="op">=</span>reservation_name, assignment<span class="op">=</span>assignment_config</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>    assignment_name <span class="op">=</span> assignment.name</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'assignment_name'</span>, assignment_name)</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># it can take a lot for the slots to be available</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Waiting for 300 seconds..."</span>)</span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">300</span>)</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> reservation_name, assignment_name</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This is Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>After the reservation is created, the account is going to be billed by time and number of slots. It can cost about $3 for each pipeline run, <strong>but you need to be very cautious about the pipeline failing before the reservation is deleted</strong>. To be sure the reservation is deleted you can go to <a href="https://console.cloud.google.com/bigquery/admin/reservations">https://console.cloud.google.com/bigquery/admin/reservations</a> and select the project of interest. Check that <strong>SLOT RESERVATIONS</strong> and <strong>SLOT COMMITMENTS</strong> are empty and look like this:</p>
<p><strong>SLOT RESERVATIONS</strong><br>
<img src="reservations.PNG" class="img-fluid"></p>
<p><strong>SLOT COMMITMENTS</strong><br>
<img src="commitments.PNG" class="img-fluid"></p>
<p>If not empty, delete them in the UI. Below you can find some scripts you can run to delete the reservations in case the pipeline fails before doing it.</p>
</div>
</div>
</section>
<section id="delete-reservation-component" class="level4">
<h4 class="anchored" data-anchor-id="delete-reservation-component">Delete Reservation Component</h4>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="at">@component</span>(packages_to_install<span class="op">=</span>[<span class="st">"google-cloud-bigquery-reservation==1.11.2"</span>])</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delete_reservation(</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    reservation_name: <span class="bu">str</span>,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    assignment_name: <span class="bu">str</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># import libraries</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> google.cloud.bigquery_reservation_v1 <span class="im">import</span> ReservationServiceClient</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Delete Assignment, Reservation and Capacity</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    reservation_client <span class="op">=</span> ReservationServiceClient()</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    reservation_client.delete_assignment(name<span class="op">=</span>assignment_name)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    reservation_client.delete_reservation(name<span class="op">=</span>reservation_name)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'reservation_name'</span>, reservation_name, <span class="st">'deleted'</span>)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'assignment_name'</span>, assignment_name, <span class="st">'deleted'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="log-eval-metrics-component" class="level4">
<h4 class="anchored" data-anchor-id="log-eval-metrics-component">Log Eval Metrics Component</h4>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="at">@component</span>()</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log_eval_metrics(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    eval_metrics: Input[Artifact], metrics: Output[Metrics]</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># import libraries</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> math</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    metadata <span class="op">=</span> eval_metrics.metadata</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r <span class="kw">in</span> metadata[<span class="st">"rows"</span>]:</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        rows <span class="op">=</span> r[<span class="st">"f"</span>]</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>        schema <span class="op">=</span> metadata[<span class="st">"schema"</span>][<span class="st">"fields"</span>]</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> {}</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> metric, value <span class="kw">in</span> <span class="bu">zip</span>(schema, rows):</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>            metric_name <span class="op">=</span> metric[<span class="st">"name"</span>]</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>            val <span class="op">=</span> <span class="bu">float</span>(value[<span class="st">"v"</span>])</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>            output[metric_name] <span class="op">=</span> val</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>            metrics.log_metric(metric_name, val)</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(output)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="deploy-model-component" class="level4">
<h4 class="anchored" data-anchor-id="deploy-model-component">Deploy Model Component</h4>
<p>The names in this function are hard coded. It assumes you keep <code>recommender_model</code> as the model dir. If it was changed previously, change it here accordingly. Also edit [PIPELINE_ROOT] with your chosen name.</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="at">@component</span>(packages_to_install<span class="op">=</span>[</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"google-cloud-build==3.18.0"</span>,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"google-api-python-client==2.93.0"</span>])</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> deploy_recommendations_model(</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    artifact_uri: <span class="bu">str</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    project: <span class="bu">str</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># import libraries</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> google.cloud.devtools <span class="im">import</span> cloudbuild</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> googleapiclient.discovery <span class="im">import</span> build</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Deploy Model</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    client <span class="op">=</span> cloudbuild.CloudBuildClient()</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    build <span class="op">=</span> cloudbuild.Build()</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fill [PIPELINE_ROOT] with your selected parameter</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If you didn't keep `recommender_model` change it accordingly</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    build.steps <span class="op">=</span> [</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        {   <span class="st">"name"</span>: <span class="st">"gcr.io/cloud-builders/gsutil"</span>,</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"args"</span>: [<span class="st">"cp"</span>, <span class="st">"-r"</span>, <span class="st">'[PIPELINE_ROOT]/recommender_model'</span>, <span class="st">"."</span>]  },</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>        {   <span class="st">"name"</span>: <span class="st">"gcr.io/cloud-builders/gsutil"</span>,</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"args"</span>: [<span class="st">"cp"</span>, <span class="st">"-r"</span>, <span class="st">'[PIPELINE_ROOT]/dockerfile/Dockerfile/'</span>, <span class="st">"Dockerfile"</span>] },</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>        {   <span class="st">"name"</span>: <span class="st">"gcr.io/cloud-builders/docker"</span>,</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"args"</span>: [<span class="st">"build"</span>, <span class="st">"-t"</span>, <span class="ss">f"gcr.io/</span><span class="sc">{</span>project<span class="sc">}</span><span class="ss">/recommender_model"</span>, <span class="st">"."</span> ]   },</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>        {   <span class="st">"name"</span>: <span class="st">"gcr.io/cloud-builders/docker"</span>,</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">"args"</span>: [<span class="st">"push"</span>, <span class="ss">f"gcr.io/</span><span class="sc">{</span>project<span class="sc">}</span><span class="ss">/recommender_model"</span>]    },</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>        {   <span class="st">"name"</span>: <span class="st">"gcr.io/cloud-builders/gcloud"</span>,</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"args"</span>: [</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">"run"</span>, <span class="st">"deploy"</span>,</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>                <span class="st">"recommender-model"</span>, <span class="st">"--image"</span>, <span class="ss">f"gcr.io/</span><span class="sc">{</span>project<span class="sc">}</span><span class="ss">/recommender_model"</span>,</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>                <span class="st">"--region"</span>, <span class="st">"us-central1"</span>, <span class="st">"--platform"</span>, <span class="st">"managed"</span>, <span class="st">"--memory"</span>, <span class="st">"500Mi"</span>,</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>                <span class="st">"--allow-unauthenticated"</span>, <span class="st">"--max-instances"</span>, <span class="st">"5"</span>, <span class="st">"--port"</span>, <span class="st">"8501"</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>    operation <span class="op">=</span> client.create_build(project_id<span class="op">=</span>project, build<span class="op">=</span>build)</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print the in-progress operation</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"IN PROGRESS:"</span>)</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(operation.metadata)</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> operation.result()</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print the completed status</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"RESULT:"</span>, result.status)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-the-docker-file-and-copy-it-to-gcs" class="level4">
<h4 class="anchored" data-anchor-id="create-the-docker-file-and-copy-it-to-gcs">Create the Docker file and copy it to GCS</h4>
<p>Keep <code>recommender_model</code> or change it accordingly.</p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile Dockerfile</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>FROM tensorflow<span class="op">/</span>serving:<span class="fl">2.4.4</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>ENTRYPOINT [<span class="st">"/usr/bin/env"</span>]</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>ENV MODEL_NAME<span class="op">=</span>recommender_model</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>ENV PORT<span class="op">=</span><span class="dv">8501</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>COPY recommender_model <span class="op">/</span>models<span class="op">/</span>recommender_model<span class="op">/</span><span class="dv">1</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>CMD tensorflow_model_server <span class="op">--</span>port<span class="op">=</span><span class="dv">8500</span> <span class="op">--</span>rest_api_port<span class="op">=</span>$PORT <span class="op">--</span>model_base_path<span class="op">=/</span>models<span class="op">/</span>recommender_model <span class="op">--</span>model_name<span class="op">=</span>$MODEL_NAME</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>docker_path <span class="op">=</span> PIPELINE_ROOT <span class="op">+</span> <span class="st">'dockerfile/'</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> gsutil cp Dockerfile {docker_path}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="pipeline-and-job" class="level3">
<h3 class="anchored" data-anchor-id="pipeline-and-job">Pipeline and Job</h3>
<section id="declare-the-pipeline" class="level4">
<h4 class="anchored" data-anchor-id="declare-the-pipeline">Declare the Pipeline</h4>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="at">@pipeline</span>(</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"bigquery-recommender-pipeline"</span>,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    pipeline_root<span class="op">=</span>PIPELINE_ROOT <span class="op">+</span> <span class="st">"bigquery-recommender-pipeline"</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> recommendation_pipeline(</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    artifact_uri: <span class="bu">str</span>,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    display_name: <span class="bu">str</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># import libraries</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> google_cloud_pipeline_components.v1.bigquery <span class="im">import</span> (</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>        BigqueryCreateModelJobOp,</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>        BigqueryEvaluateModelJobOp,</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>        BigqueryExportModelJobOp</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NODE create-reservation</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    project <span class="op">=</span> PROJECT_ID</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    location <span class="op">=</span> <span class="st">"us"</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    slots <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    reservation_id <span class="op">=</span> <span class="st">"matrix-factorization-reservation"</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    create_reservation_task <span class="op">=</span> create_reservation(</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>        project<span class="op">=</span>project, location<span class="op">=</span>location, commitment_slots<span class="op">=</span>slots, reservation_id<span class="op">=</span>reservation_id</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NODE create-model-task</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Query for training</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>    num_factors <span class="op">=</span> <span class="dv">60</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>    q <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a><span class="ss">    CREATE OR REPLACE MODEL </span><span class="sc">{</span>MODEL_DATASET<span class="sc">}</span><span class="ss">.model_00</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a><span class="ss">    OPTIONS</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a><span class="ss">        (model_type='matrix_factorization',</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a><span class="ss">        user_col='user_id',</span></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a><span class="ss">        item_col='item_id',</span></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a><span class="ss">        RATING_COL='rating',</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a><span class="ss">        feedback_type='EXPLICIT',</span></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a><span class="ss">        l2_reg=9.83,</span></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a><span class="ss">        num_factors=</span><span class="sc">{</span>num_factors<span class="sc">}</span><span class="ss">) AS</span></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a><span class="ss">    SELECT user_id, item_id, rating FROM </span><span class="sc">{</span>MOVIELENS_DATASET<span class="sc">}</span><span class="ss">.movielens_1m</span></span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a><span class="ss">    """</span></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>    create_model_task <span class="op">=</span> BigqueryCreateModelJobOp(</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>        project<span class="op">=</span>project,</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>        location<span class="op">=</span>location,</span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>        query<span class="op">=</span>q,</span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>    ).after(create_reservation_task)</span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NODE evaluate-model-task</span></span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>    bq_evaluate_task <span class="op">=</span> BigqueryEvaluateModelJobOp(</span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>        project<span class="op">=</span>project, location<span class="op">=</span>location, model<span class="op">=</span>create_model_task.outputs[<span class="st">"model"</span>]</span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>    ).after(create_model_task)</span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NODE delete-reservation</span></span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>    delete_reservation_task <span class="op">=</span> delete_reservation(</span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a>        reservation_name<span class="op">=</span>create_reservation_task.outputs[<span class="st">"reservation_name"</span>],</span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a>        assignment_name<span class="op">=</span>create_reservation_task.outputs[<span class="st">"assignment_name"</span>]</span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>    ).after(bq_evaluate_task)</span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NODE log-eval-metrics</span></span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a>    bqml_eval_metrics_raw <span class="op">=</span> bq_evaluate_task.outputs[<span class="st">"evaluation_metrics"</span>]</span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a>    log_eval_metrics_task <span class="op">=</span> log_eval_metrics(</span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a>        eval_metrics<span class="op">=</span>bqml_eval_metrics_raw</span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NODE export-bq-model-to-gcs</span></span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true" tabindex="-1"></a>    bq_export_task <span class="op">=</span> BigqueryExportModelJobOp(</span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true" tabindex="-1"></a>        project<span class="op">=</span>project,</span>
<span id="cb34-68"><a href="#cb34-68" aria-hidden="true" tabindex="-1"></a>        location<span class="op">=</span>location,</span>
<span id="cb34-69"><a href="#cb34-69" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>create_model_task.outputs[<span class="st">"model"</span>],</span>
<span id="cb34-70"><a href="#cb34-70" aria-hidden="true" tabindex="-1"></a>        model_destination_path<span class="op">=</span>artifact_uri,</span>
<span id="cb34-71"><a href="#cb34-71" aria-hidden="true" tabindex="-1"></a>    ).after(create_model_task)</span>
<span id="cb34-72"><a href="#cb34-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-73"><a href="#cb34-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NODE deploy-model-cloud-run</span></span>
<span id="cb34-74"><a href="#cb34-74" aria-hidden="true" tabindex="-1"></a>    deploy_recommendations_model_task <span class="op">=</span> deploy_recommendations_model(</span>
<span id="cb34-75"><a href="#cb34-75" aria-hidden="true" tabindex="-1"></a>        artifact_uri<span class="op">=</span>artifact_uri,</span>
<span id="cb34-76"><a href="#cb34-76" aria-hidden="true" tabindex="-1"></a>        project<span class="op">=</span>project</span>
<span id="cb34-77"><a href="#cb34-77" aria-hidden="true" tabindex="-1"></a>    ).after(bq_export_task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="compile-the-pipeline" class="level4">
<h4 class="anchored" data-anchor-id="compile-the-pipeline">Compile the Pipeline</h4>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>compiler.Compiler().<span class="bu">compile</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    pipeline_func<span class="op">=</span>recommendation_pipeline,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    package_path<span class="op">=</span><span class="st">"recommendation_pipeline.json"</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-and-run-the-job" class="level4">
<h4 class="anchored" data-anchor-id="create-and-run-the-job">Create and Run the Job</h4>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>job <span class="op">=</span> pipeline_jobs.PipelineJob(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    enable_caching<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"recommendation-pipeline"</span>,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    template_path<span class="op">=</span><span class="st">"recommendation_pipeline.json"</span>,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    parameter_values<span class="op">=</span>{</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"artifact_uri"</span>: MODEL_DIR,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"display_name"</span>: <span class="st">"recommendation"</span>,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>job.run(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    service_account<span class="op">=</span>SERVICE_ACCOUNT,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    sync<span class="op">=</span><span class="va">False</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The pipeline can be monitored here: - <a href="https://console.cloud.google.com/vertex-ai/pipelines">GCP COnsole: Vertex AI Pipelines</a></p>
<p>And if all went fine, you must see a beautiful picture like this:</p>
<p><img src="pipeline.PNG" class="img-fluid"></p>
</section>
</section>
</section>
<section id="make-sure-no-reservation-or-slot-assignment-is-active" class="level2">
<h2 class="anchored" data-anchor-id="make-sure-no-reservation-or-slot-assignment-is-active">Make sure no reservation or slot assignment is active</h2>
<p>If the pipeline fails before deleting the reservation, this command lists the reservations, if any.</p>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> bq ls <span class="op">--</span>reservation <span class="op">--</span>project_id<span class="op">=</span>{PROJECT_ID} <span class="op">--</span>location<span class="op">=</span>us</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And this command shows the assignment.</p>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> bq show <span class="op">--</span>project_id<span class="op">=</span>{PROJECT_ID} <span class="op">--</span>location<span class="op">=</span>us <span class="op">--</span>reservation_assignment <span class="op">--</span>job_type<span class="op">=</span>QUERY <span class="op">--</span>assignee_id<span class="op">=</span>{PROJECT_ID} <span class="op">--</span>assignee_type<span class="op">=</span>PROJECT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="delete-any-reservation-and-assignment" class="level3">
<h3 class="anchored" data-anchor-id="delete-any-reservation-and-assignment">Delete any reservation and assignment</h3>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>shell_output <span class="op">=</span> <span class="op">!</span> bq show <span class="op">--</span>project_id<span class="op">=</span>{PROJECT_ID} <span class="op">--</span>location<span class="op">=</span>us <span class="op">--</span>reservation_assignment <span class="op">--</span>job_type<span class="op">=</span>QUERY <span class="op">--</span>assignee_id<span class="op">=</span>{PROJECT_ID} <span class="op">--</span>assignee_type<span class="op">=</span>PROJECT</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>assignment_id <span class="op">=</span> shell_output[<span class="dv">2</span>].split(<span class="st">' '</span>)[<span class="dv">2</span>].split(<span class="st">'.'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>reservation_id <span class="op">=</span> <span class="st">'matrix-factorization-reservation'</span> <span class="co"># As declared in the pipeline</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co"># remove assignment</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> bq rm <span class="op">--</span>project_id<span class="op">=</span>{PROJECT_ID} <span class="op">--</span>location<span class="op">=</span>us <span class="op">--</span>reservation_assignment {reservation_id}.{assignment_id}</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co"># remove reservation</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> bq rm <span class="op">--</span>project_id<span class="op">=</span>{PROJECT_ID} <span class="op">--</span>location<span class="op">=</span>us <span class="op">--</span>reservation {reservation_id}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="monitor-the-process" class="level2">
<h2 class="anchored" data-anchor-id="monitor-the-process">Monitor the process</h2>
<ul>
<li>https://console.cloud.google.com/cloud-build/builds?project=[your-project-id]</li>
<li>https://console.cloud.google.com/run?project=[your-project-id]</li>
<li>https://console.cloud.google.com/vertex-ai/pipelines/runs?project=[your-project-id]</li>
</ul>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<p>An that’s about it. The automated process for training an deploying the model using BigQuery ML and Vertex AI pipeline. In <a href="../../posts/2023-07_bigqueryml_vertexai_recsys/bqml_vertex_recsys__part2.html">Part 2</a> we will see how to do inference and how to get insight from the embeddings (latent factors) learned by the model for each item and user.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Francisco Mussari">
<meta name="dcterms.date" content="2023-07-30">

<title>datamatica - Collaborative Filtering with PyTorch and miniai - MovieLens 20M</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">datamatica</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/fmussari" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/francisco-mussari-432b781a6/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Collaborative Filtering with PyTorch and miniai - MovieLens 20M</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Movielens</div>
                <div class="quarto-category">miniai</div>
                <div class="quarto-category">PyTorch</div>
                <div class="quarto-category">RecSys</div>
                <div class="quarto-category">Recommender</div>
                <div class="quarto-category">Movielens 20M</div>
                <div class="quarto-category">t-SNE</div>
                <div class="quarto-category">Embeddings</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Francisco Mussari </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 30, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#hardware" id="toc-hardware" class="nav-link" data-scroll-target="#hardware">Hardware</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  <li><a href="#import-libraries" id="toc-import-libraries" class="nav-link" data-scroll-target="#import-libraries">Import libraries</a>
  <ul class="collapse">
  <li><a href="#miniai" id="toc-miniai" class="nav-link" data-scroll-target="#miniai">miniai</a></li>
  </ul></li>
  <li><a href="#load-movielens-20m" id="toc-load-movielens-20m" class="nav-link" data-scroll-target="#load-movielens-20m">Load Movielens 20M</a></li>
  <li><a href="#eda" id="toc-eda" class="nav-link" data-scroll-target="#eda">EDA</a>
  <ul class="collapse">
  <li><a href="#records-with-more-than-one-item_id-per-title" id="toc-records-with-more-than-one-item_id-per-title" class="nav-link" data-scroll-target="#records-with-more-than-one-item_id-per-title">Records with more than one <code>item_id</code> per <code>title</code></a></li>
  </ul></li>
  <li><a href="#merge-dataframes" id="toc-merge-dataframes" class="nav-link" data-scroll-target="#merge-dataframes">Merge dataframes</a></li>
  <li><a href="#train-and-valid-splits" id="toc-train-and-valid-splits" class="nav-link" data-scroll-target="#train-and-valid-splits">Train and Valid Splits</a>
  <ul class="collapse">
  <li><a href="#modify-splits-to-have-all-users-in-valid" id="toc-modify-splits-to-have-all-users-in-valid" class="nav-link" data-scroll-target="#modify-splits-to-have-all-users-in-valid">Modify splits to have all users in valid</a></li>
  </ul></li>
  <li><a href="#pytorch-dataset" id="toc-pytorch-dataset" class="nav-link" data-scroll-target="#pytorch-dataset">PyTorch Dataset</a>
  <ul class="collapse">
  <li><a href="#optimized-dataset" id="toc-optimized-dataset" class="nav-link" data-scroll-target="#optimized-dataset">Optimized Dataset</a></li>
  </ul></li>
  <li><a href="#pytorch-dataloader" id="toc-pytorch-dataloader" class="nav-link" data-scroll-target="#pytorch-dataloader">PyTorch Dataloader</a>
  <ul class="collapse">
  <li><a href="#batch-sampler" id="toc-batch-sampler" class="nav-link" data-scroll-target="#batch-sampler">Batch Sampler</a></li>
  <li><a href="#dataloader" id="toc-dataloader" class="nav-link" data-scroll-target="#dataloader">DataLoader</a></li>
  </ul></li>
  <li><a href="#miniai-dataloaders" id="toc-miniai-dataloaders" class="nav-link" data-scroll-target="#miniai-dataloaders">miniai DataLoaders</a></li>
  <li><a href="#model" id="toc-model" class="nav-link" data-scroll-target="#model">Model</a></li>
  <li><a href="#training-with-miniai" id="toc-training-with-miniai" class="nav-link" data-scroll-target="#training-with-miniai">Training with miniai</a>
  <ul class="collapse">
  <li><a href="#hyperparameters-set-1" id="toc-hyperparameters-set-1" class="nav-link" data-scroll-target="#hyperparameters-set-1">Hyperparameters Set # 1</a></li>
  <li><a href="#hyperparameters-set-2" id="toc-hyperparameters-set-2" class="nav-link" data-scroll-target="#hyperparameters-set-2">Hyperparameters Set # 2</a></li>
  </ul></li>
  <li><a href="#recommend-movies-to-users" id="toc-recommend-movies-to-users" class="nav-link" data-scroll-target="#recommend-movies-to-users">Recommend movies to users</a></li>
  <li><a href="#interpreting-results" id="toc-interpreting-results" class="nav-link" data-scroll-target="#interpreting-results">Interpreting Results</a>
  <ul class="collapse">
  <li><a href="#bias" id="toc-bias" class="nav-link" data-scroll-target="#bias">Bias</a></li>
  </ul></li>
  <li><a href="#embeddings" id="toc-embeddings" class="nav-link" data-scroll-target="#embeddings">Embeddings</a>
  <ul class="collapse">
  <li><a href="#popular-movies" id="toc-popular-movies" class="nav-link" data-scroll-target="#popular-movies">Popular Movies</a></li>
  <li><a href="#popular-movies-embeddings" id="toc-popular-movies-embeddings" class="nav-link" data-scroll-target="#popular-movies-embeddings">Popular movies embeddings</a></li>
  </ul></li>
  <li><a href="#visualizing-the-embeddings" id="toc-visualizing-the-embeddings" class="nav-link" data-scroll-target="#visualizing-the-embeddings">Visualizing the embeddings</a>
  <ul class="collapse">
  <li><a href="#dimensionality-reduction-pca" id="toc-dimensionality-reduction-pca" class="nav-link" data-scroll-target="#dimensionality-reduction-pca">Dimensionality reduction: PCA</a></li>
  <li><a href="#dimensionality-reduction-t-sne" id="toc-dimensionality-reduction-t-sne" class="nav-link" data-scroll-target="#dimensionality-reduction-t-sne">Dimensionality reduction: t-SNE</a></li>
  <li><a href="#helper-functions" id="toc-helper-functions" class="nav-link" data-scroll-target="#helper-functions">Helper functions</a></li>
  <li><a href="#pca" id="toc-pca" class="nav-link" data-scroll-target="#pca">PCA</a></li>
  <li><a href="#t-sne" id="toc-t-sne" class="nav-link" data-scroll-target="#t-sne">t-SNE</a></li>
  <li><a href="#highlight-movies" id="toc-highlight-movies" class="nav-link" data-scroll-target="#highlight-movies">Highlight movies</a></li>
  </ul></li>
  <li><a href="#highlight-genres" id="toc-highlight-genres" class="nav-link" data-scroll-target="#highlight-genres">Highlight genres</a>
  <ul class="collapse">
  <li><a href="#documentary" id="toc-documentary" class="nav-link" data-scroll-target="#documentary">Documentary</a></li>
  <li><a href="#horror" id="toc-horror" class="nav-link" data-scroll-target="#horror">Horror</a></li>
  </ul></li>
  <li><a href="#find-similar-movies" id="toc-find-similar-movies" class="nav-link" data-scroll-target="#find-similar-movies">Find similar movies</a></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">Conclusions</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>In this post we are going to train a Matrix Factorization model on <a href="https://grouplens.org/datasets/movielens/20m/">MovieLens 20M Dataset</a>.</p>
<p>For the training we are going to use raw PyTorch and miniai.</p>
<p>After the model is trained, we will interpret the results by recommending movies to a given user, analyzing movies’ bias, and visualizing the embeddings by reducing dimensionality using PCA and t-SNE. We will also find similar movies to a given one using cosine similarity.</p>
</section>
<section id="hardware" class="level2">
<h2 class="anchored" data-anchor-id="hardware">Hardware</h2>
<p>I ran the training on an old GTX 1070 GPU. Maybe a modern CPU is enough to do the job. Or you can run this notebook in Colab. To install miniai in Colab run the next two cells.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clone miniai repository</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> git clone https:<span class="op">//</span>github.com<span class="op">/</span>fastai<span class="op">/</span>course22p2.git</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Install miniai</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> pip install <span class="op">-</span>e course22p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Automatically restart kernel after installs so that your environment can access the new packages</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> IPython</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> IPython.Application.instance()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>app.kernel.do_shutdown(<span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://github.com/fastai/fastbook/blob/master/08_collab.ipynb">Fastbook: Collaborative Filtering Deep Dive</a></li>
<li><a href="https://www.kaggle.com/code/jhoward/collaborative-filtering-deep-dive">Kaggle: Collaborative Filtering Deep Dive</a></li>
<li><a href="https://en.wikipedia.org/wiki/Matrix_factorization_(recommender_systems)">Wikipedia: Matrix factorization (recommender systems)</a></li>
<li><a href="https://developers.google.com/machine-learning/recommendation/collaborative/basics">Google Dev: Collaborative Filtering</a></li>
<li><a href="https://github.com/microsoft/recommenders">Github: Recommenders (Microsoft)</a></li>
<li><a href="https://www.kaggle.com/code/colinmorris/visualizing-embeddings-with-t-sne">Kaggle: Visualizing Embeddings With t-SNE</a></li>
<li><a href="https://wasimlorgat.com/posts/image-vector-search.html">Building a cost-effective image vector search engine with CLIP</a></li>
</ul>
</section>
<section id="import-libraries" class="level2">
<h2 class="anchored" data-anchor-id="import-libraries">Import libraries</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> urllib.request</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zipfile</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.optim <span class="im">import</span> AdamW, lr_scheduler</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> (</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    Dataset, DataLoader, RandomSampler, BatchSampler</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lets download a script to split the data from gist, based on code from <a href="https://github.com/microsoft/recommenders">Recommenders (Microsoft)</a> Github repository.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>gist_id <span class="op">=</span> <span class="st">'f6fdb783ab99a37259bec182f864a988'</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="ss">f"https://gist.github.com/</span><span class="sc">{</span>gist_id<span class="sc">}</span><span class="ss">.git"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>folder <span class="op">=</span> <span class="st">'recommender_split'</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> git clone {url} {folder}</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> recommender_split.recommender_split <span class="im">import</span> split_dataframe_by_group, report_splits</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cloning into 'recommender_split'...
remote: Enumerating objects: 3, done.
remote: Counting objects: 100% (3/3), done.
remote: Compressing objects: 100% (2/2), done.
remote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0
Unpacking objects: 100% (3/3), 1.30 KiB | 14.00 KiB/s, done.</code></pre>
</div>
</div>
<section id="miniai" class="level3">
<h3 class="anchored" data-anchor-id="miniai">miniai</h3>
<p>We are using <a href="https://github.com/fastai/course22p2">miniai</a> framework.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> miniai.datasets <span class="im">import</span> DataLoaders</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> miniai.learner <span class="im">import</span> MetricsCB, DeviceCB, ProgressCB, TrainLearner</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> miniai.activations <span class="im">import</span> set_seed</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> miniai.sgd <span class="im">import</span> BatchSchedCB, RecorderCB</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="load-movielens-20m" class="level2">
<h2 class="anchored" data-anchor-id="load-movielens-20m">Load Movielens 20M</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>USER <span class="op">=</span> <span class="st">'user_id'</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>ITEM <span class="op">=</span> <span class="st">'item_id'</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>TARGET <span class="op">=</span> <span class="st">'rating'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>movielens_20M_url <span class="op">=</span> <span class="st">'https://files.grouplens.org/datasets/movielens/ml-20m.zip'</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> Path(movielens_20M_url).name</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>zip_path <span class="op">=</span> Path(<span class="st">'.'</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>extract_path <span class="op">=</span> zip_path <span class="op">/</span> Path(filename).stem</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> Path(filename).exists():</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> urllib.request.urlopen(movielens_20M_url) <span class="im">as</span> response:</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">"wb"</span>) <span class="im">as</span> f:</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>          f.write(response.read())</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> extract_path.exists():</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> zipfile.ZipFile(filename, <span class="st">"r"</span>) <span class="im">as</span> zip_ref:</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        zip_ref.extractall(zip_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ratings_20m <span class="op">=</span> pd.read_csv(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    extract_path<span class="op">/</span><span class="st">'ratings.csv'</span>, header<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    names<span class="op">=</span>[USER, ITEM, TARGET, <span class="st">'timestamp'</span>])</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>ratings_20m <span class="op">=</span> ratings_20m[[USER, ITEM, TARGET]].copy()</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>movies_20m <span class="op">=</span> pd.read_csv(</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    extract_path<span class="op">/</span><span class="st">'movies.csv'</span>, encoding<span class="op">=</span><span class="st">'utf-8'</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    usecols<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>), header<span class="op">=</span><span class="dv">0</span>, names<span class="op">=</span>[ITEM, <span class="st">'title'</span>, <span class="st">'genres'</span>]</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>ratings_20m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">rating</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>2</td>
<td>3.5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>29</td>
<td>3.5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1</td>
<td>32</td>
<td>3.5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1</td>
<td>47</td>
<td>3.5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1</td>
<td>50</td>
<td>3.5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20000258</td>
<td>138493</td>
<td>68954</td>
<td>4.5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20000259</td>
<td>138493</td>
<td>69526</td>
<td>4.5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20000260</td>
<td>138493</td>
<td>69644</td>
<td>3.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20000261</td>
<td>138493</td>
<td>70286</td>
<td>5.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20000262</td>
<td>138493</td>
<td>71619</td>
<td>2.5</td>
</tr>
</tbody>
</table>

<p>20000263 rows × 3 columns</p>
</div>
</div>
</div>
</section>
<section id="eda" class="level2">
<h2 class="anchored" data-anchor-id="eda">EDA</h2>
<section id="records-with-more-than-one-item_id-per-title" class="level3">
<h3 class="anchored" data-anchor-id="records-with-more-than-one-item_id-per-title">Records with more than one <code>item_id</code> per <code>title</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> movies_20m.groupby(<span class="st">'title'</span>)[<span class="st">'item_id'</span>].count().reset_index()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>titles <span class="op">=</span> g[g.item_id<span class="op">&gt;</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>movies_20m[movies_20m.title.isin(titles.title)].sort_values(<span class="st">'title'</span>).head(<span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">genres</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">24064</td>
<td>114130</td>
<td>20,000 Leagues Under the Sea (1997)</td>
<td>Romance|Sci-Fi</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20923</td>
<td>102190</td>
<td>20,000 Leagues Under the Sea (1997)</td>
<td>Adventure|Romance|Sci-Fi</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">582</td>
<td>588</td>
<td>Aladdin (1992)</td>
<td>Adventure|Animation|Children|Comedy|Musical</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">24092</td>
<td>114240</td>
<td>Aladdin (1992)</td>
<td>Adventure|Animation|Children|Comedy|Fantasy</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24437</td>
<td>115777</td>
<td>Beneath (2013)</td>
<td>Horror</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21429</td>
<td>104035</td>
<td>Beneath (2013)</td>
<td>Horror</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<ul>
<li>By inspecting movies with the link <code>https://movielens.org/movies/&lt;item_id&gt;</code>, we can conclude that each title corresponds to an unique movie, even though they share the same title and release year.</li>
<li>Some titles in the dataset refer to the original title, for example <a href="https://movielens.org/movies/67459">item_id=67459</a> is “Chaos (2005)” and not “The Deadly Hostage (2005)”.</li>
</ul>
</section>
</section>
<section id="merge-dataframes" class="level2">
<h2 class="anchored" data-anchor-id="merge-dataframes">Merge dataframes</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>ratings_20m <span class="op">=</span> ratings_20m.merge(movies_20m, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>ratings_20m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">rating</th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">genres</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>2</td>
<td>3.5</td>
<td>Jumanji (1995)</td>
<td>Adventure|Children|Fantasy</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>29</td>
<td>3.5</td>
<td>City of Lost Children, The (Cité des enfants p...</td>
<td>Adventure|Drama|Fantasy|Mystery|Sci-Fi</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1</td>
<td>32</td>
<td>3.5</td>
<td>Twelve Monkeys (a.k.a. 12 Monkeys) (1995)</td>
<td>Mystery|Sci-Fi|Thriller</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1</td>
<td>47</td>
<td>3.5</td>
<td>Seven (a.k.a. Se7en) (1995)</td>
<td>Mystery|Thriller</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1</td>
<td>50</td>
<td>3.5</td>
<td>Usual Suspects, The (1995)</td>
<td>Crime|Mystery|Thriller</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20000258</td>
<td>138493</td>
<td>68954</td>
<td>4.5</td>
<td>Up (2009)</td>
<td>Adventure|Animation|Children|Drama</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20000259</td>
<td>138493</td>
<td>69526</td>
<td>4.5</td>
<td>Transformers: Revenge of the Fallen (2009)</td>
<td>Action|Adventure|Sci-Fi|IMAX</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20000260</td>
<td>138493</td>
<td>69644</td>
<td>3.0</td>
<td>Ice Age: Dawn of the Dinosaurs (2009)</td>
<td>Action|Adventure|Animation|Children|Comedy|Rom...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20000261</td>
<td>138493</td>
<td>70286</td>
<td>5.0</td>
<td>District 9 (2009)</td>
<td>Mystery|Sci-Fi|Thriller</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20000262</td>
<td>138493</td>
<td>71619</td>
<td>2.5</td>
<td>Coco Before Chanel (Coco avant Chanel) (2009)</td>
<td>Drama</td>
</tr>
</tbody>
</table>

<p>20000263 rows × 5 columns</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">not</span> <span class="bu">any</span>(ratings_20m.title.isna())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> ratings_20m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="train-and-valid-splits" class="level2">
<h2 class="anchored" data-anchor-id="train-and-valid-splits">Train and Valid Splits</h2>
<p>This function splits the dataframe. If <code>filter_by</code> is <code>item</code> it assures that all items specified in the columns <code>col_item</code> are going to be present in both train and valid, except for those with only one row (review).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>splits <span class="op">=</span> split_dataframe_by_group(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    data, ratio<span class="op">=</span><span class="fl">0.8</span>, filter_by<span class="op">=</span><span class="st">"item"</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    seed<span class="op">=</span><span class="dv">42</span>, col_user<span class="op">=</span>USER, col_item<span class="op">=</span>ITEM</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> data.iloc[splits[<span class="dv">0</span>]]</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>valid_df <span class="op">=</span> data.iloc[splits[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>report_splits(data, splits, USER, ITEM, ITEM)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of item_id with one review: 3972
Number of users in train: 138493
Number of items in train: 26744
Number of users in valid: 138333
Number of items in valid: 22772</code></pre>
</div>
</div>
<p>All items with more than one review are present in <code>valid_df</code>: <code>26,744 = 22,772 + 3,972</code>.</p>
<p>But there are users that are not present:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>users_not_in_valid <span class="op">=</span> <span class="bu">set</span>(train_df[USER]) <span class="op">-</span> <span class="bu">set</span>(valid_df[USER])</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span><span class="bu">len</span>(users_not_in_valid)<span class="sc">}</span><span class="ss"> users not present in valid split"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 160 users not present in valid split</code></pre>
</div>
</div>
<section id="modify-splits-to-have-all-users-in-valid" class="level3">
<h3 class="anchored" data-anchor-id="modify-splits-to-have-all-users-in-valid">Modify splits to have all users in valid</h3>
<p>We can now take the ratings dataframe with only the users not present in valid, and split it using <code>user</code> in the <code>filter_by</code> parameter. That way we assure that that set of users are going to be present both in train and valid.<br>
Using the <code>sort_column</code> parameter means that the item with more reviews are the ones that goes to valid, so it is less likely to remove movies from training.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>sort_column <span class="op">=</span> <span class="st">'numrev_by_item'</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>number_of_reviews_by_item <span class="op">=</span> data.groupby(ITEM)[ITEM].transform(<span class="st">'count'</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>tmp_filter <span class="op">=</span> data[USER].isin(users_not_in_valid)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>df_new_splits <span class="op">=</span> data[tmp_filter].copy()</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>df_new_splits[sort_column] <span class="op">=</span> number_of_reviews_by_item[tmp_filter]</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>df_new_splits.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">rating</th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">genres</th>
<th data-quarto-table-cell-role="th">numrev_by_item</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">92313</td>
<td>641</td>
<td>107</td>
<td>2.5</td>
<td>Muppet Treasure Island (1996)</td>
<td>Adventure|Children|Comedy|Musical</td>
<td>6376</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">92314</td>
<td>641</td>
<td>135</td>
<td>4.0</td>
<td>Down Periscope (1996)</td>
<td>Comedy</td>
<td>6305</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">92315</td>
<td>641</td>
<td>405</td>
<td>3.5</td>
<td>Highlander III: The Sorcerer (a.k.a. Highlande...</td>
<td>Action|Fantasy</td>
<td>3554</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">92316</td>
<td>641</td>
<td>542</td>
<td>5.0</td>
<td>Son in Law (1993)</td>
<td>Comedy|Drama|Romance</td>
<td>3491</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">92317</td>
<td>641</td>
<td>765</td>
<td>4.0</td>
<td>Jack (1996)</td>
<td>Comedy|Drama</td>
<td>4812</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>new_splits <span class="op">=</span> split_dataframe_by_group(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    df_new_splits, ratio<span class="op">=</span><span class="fl">0.8</span>, filter_by<span class="op">=</span><span class="st">"user"</span>,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    seed<span class="op">=</span><span class="dv">104577657</span>, col_user<span class="op">=</span>USER, col_item<span class="op">=</span>ITEM, sort_column<span class="op">=</span>sort_column</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Add the indices from both splits:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>final_splits <span class="op">=</span> [splits[<span class="dv">0</span>] <span class="op">+</span> new_splits[<span class="dv">0</span>], splits[<span class="dv">1</span>] <span class="op">+</span> new_splits[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> data.iloc[final_splits[<span class="dv">0</span>]]</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>valid_df <span class="op">=</span> data.iloc[final_splits[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(train_df), <span class="bu">len</span>(valid_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(15994636, 4009300)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(train_df)<span class="op">/</span><span class="bu">len</span>(data)<span class="sc">:.2f}</span><span class="ss">"</span>, <span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(valid_df)<span class="op">/</span><span class="bu">len</span>(data)<span class="sc">:.2f}</span><span class="ss">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>('0.80', '0.20')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>report_splits(data, final_splits, USER, ITEM, ITEM)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of item_id with one review: 3972
Number of users in train: 138493
Number of items in train: 26744
Number of users in valid: 138493
Number of items in valid: 22772</code></pre>
</div>
</div>
<p>Now we have all items in train and valid except those with only one review, and all users in train and valid.</p>
</section>
</section>
<section id="pytorch-dataset" class="level2">
<h2 class="anchored" data-anchor-id="pytorch-dataset">PyTorch Dataset</h2>
<p>First lets create the dictionaries to do the mapping between users, items and indices:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>users <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">list</span>(data[USER].unique()))</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">list</span>(data[ITEM].unique()))</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># user index to user_id</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>uidx2u <span class="op">=</span> {k:v <span class="cf">for</span> k,v <span class="kw">in</span> <span class="bu">enumerate</span>(users)}</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co"># user_id to user index</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>u2uidx <span class="op">=</span> {k:v <span class="cf">for</span> v,k <span class="kw">in</span> uidx2u.items()}</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># item index to item_id</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>iidx2i <span class="op">=</span> {k:v <span class="cf">for</span> k,v <span class="kw">in</span> <span class="bu">enumerate</span>(items)}</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co"># item_id to item index</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>i2iidx <span class="op">=</span> {k:v <span class="cf">for</span> v,k <span class="kw">in</span> iidx2i.items()}</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co"># item index to title</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> iidx2title(iidx):</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> movies_20m[movies_20m.item_id<span class="op">==</span>iidx2i[iidx]].title.item()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(uidx2u), <span class="bu">len</span>(iidx2i)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(138493, 26744)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># item_id==3351</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>iidx2title(i2iidx[<span class="dv">3351</span>]), i2iidx[<span class="dv">3351</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>('Two Thousand Maniacs! (1964)', 3264)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># item index 31 and 150</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>iidx2title(<span class="dv">31</span>), iidx2title(<span class="dv">150</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>('Twelve Monkeys (a.k.a. 12 Monkeys) (1995)', 'Addiction, The (1995)')</code></pre>
</div>
</div>
<section id="optimized-dataset" class="level3">
<h3 class="anchored" data-anchor-id="optimized-dataset">Optimized Dataset</h3>
<p>This Dataset has some peculiarities:</p>
<ul>
<li>The mapping of users and titles and the conversion to numpy is done for the full dataframe when the object is created. Another way would be to map and convert partially in the <code>get_batch</code> function. This last approach would benefit with the number of worker the dataloaders use. The one we are using here doesn’t, as we will see. but anyway it is faster.</li>
<li>The Dataset receives a list of indices instead of an individual index, and therefore directly returns a batch.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CollabDatasetOpt(Dataset):</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, df:pd.DataFrame, user_col<span class="op">=</span><span class="st">'user'</span>, item_col<span class="op">=</span><span class="st">'item'</span>, target<span class="op">=</span><span class="st">'rating'</span>):</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.users <span class="op">=</span> df[user_col].<span class="bu">map</span>(u2uidx).to_numpy()</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.items <span class="op">=</span> df[item_col].<span class="bu">map</span>(i2iidx).to_numpy()</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.target <span class="op">=</span> df[target].to_numpy()</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.users)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_batch(<span class="va">self</span>, batch_idxs):</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>        users_b <span class="op">=</span> <span class="va">self</span>.users[batch_idxs]</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>        items_b <span class="op">=</span> <span class="va">self</span>.items[batch_idxs]</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>        x_b <span class="op">=</span> np.column_stack((users_b, items_b))</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>        target_b <span class="op">=</span> <span class="va">self</span>.target[batch_idxs]</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>        y_b <span class="op">=</span> torch.tensor(target_b, dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.tensor(x_b), y_b</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, batch_idxs):</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.get_batch(batch_idxs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>t_dataset <span class="op">=</span> CollabDatasetOpt(train_df, user_col<span class="op">=</span>USER, item_col<span class="op">=</span>ITEM)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>v_dataset <span class="op">=</span> CollabDatasetOpt(valid_df, user_col<span class="op">=</span>USER, item_col<span class="op">=</span>ITEM)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="pytorch-dataloader" class="level2">
<h2 class="anchored" data-anchor-id="pytorch-dataloader">PyTorch Dataloader</h2>
<section id="batch-sampler" class="level3">
<h3 class="anchored" data-anchor-id="batch-sampler">Batch Sampler</h3>
<p>Since the dataset receives a batch of indices, lets create a <code>BatchSampler</code> first.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>bs <span class="op">=</span> <span class="dv">64</span> <span class="op">*</span> <span class="dv">50</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>t_sampler <span class="op">=</span> BatchSampler(</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    RandomSampler(t_dataset),</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>bs, drop_last<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>v_sampler <span class="op">=</span> BatchSampler(</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    RandomSampler(v_dataset),</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>bs<span class="op">*</span><span class="dv">2</span>, drop_last<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="ss">f"Number of batches: </span><span class="sc">{</span><span class="bu">len</span>(t_sampler)<span class="sc">:,}</span><span class="ss">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'Number of batches: 4,999'</code></pre>
</div>
</div>
<p>How much it takes to loop the train dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> t_sampler: </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    t_dataset[_]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 21.3 s, sys: 967 ms, total: 22.3 s
Wall time: 20.2 s</code></pre>
</div>
</div>
</section>
<section id="dataloader" class="level3">
<h3 class="anchored" data-anchor-id="dataloader">DataLoader</h3>
<p>Lets test some values for <code>num_workers</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>t_dataloader <span class="op">=</span> DataLoader(t_dataset, sampler<span class="op">=</span>t_sampler, batch_size<span class="op">=</span><span class="va">None</span>, num_workers<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>v_dataloader <span class="op">=</span> DataLoader(v_dataset, sampler<span class="op">=</span>v_sampler, batch_size<span class="op">=</span><span class="va">None</span>, num_workers<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> t_dataloader: <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 22.1 s, sys: 8.67 s, total: 30.8 s
Wall time: 29 s</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>t_dataloader <span class="op">=</span> DataLoader(t_dataset, sampler<span class="op">=</span>t_sampler, batch_size<span class="op">=</span><span class="va">None</span>, num_workers<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>v_dataloader <span class="op">=</span> DataLoader(v_dataset, sampler<span class="op">=</span>v_sampler, batch_size<span class="op">=</span><span class="va">None</span>, num_workers<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> t_dataloader: <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 21.3 s, sys: 8.21 s, total: 29.6 s
Wall time: 28.8 s</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>t_dataloader <span class="op">=</span> DataLoader(t_dataset, sampler<span class="op">=</span>t_sampler, batch_size<span class="op">=</span><span class="va">None</span>, num_workers<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>v_dataloader <span class="op">=</span> DataLoader(v_dataset, sampler<span class="op">=</span>v_sampler, batch_size<span class="op">=</span><span class="va">None</span>, num_workers<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> t_dataloader: <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 20.5 s, sys: 934 ms, total: 21.5 s
Wall time: 19.3 s</code></pre>
</div>
</div>
</section>
</section>
<section id="miniai-dataloaders" class="level2">
<h2 class="anchored" data-anchor-id="miniai-dataloaders">miniai DataLoaders</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> DataLoaders(t_dataloader, v_dataloader)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>dt <span class="op">=</span> dls.train</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>xb, yb <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(dt))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lets see how does a batch looks like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>xb[:<span class="dv">5</span>,:], yb[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[ 13804,   1276],
         [111577,    436],
         [ 75077,    206],
         [ 38963,    481],
         [ 51319,   1884]]),
 tensor([5., 4., 3., 3., 5.]))</code></pre>
</div>
</div>
<p>Number of users and items in the dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>n_users <span class="op">=</span> <span class="bu">len</span>(data[USER].unique())</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>n_items <span class="op">=</span> <span class="bu">len</span>(data[ITEM].unique())</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>n_users, n_items</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(138493, 26744)</code></pre>
</div>
</div>
</section>
<section id="model" class="level2">
<h2 class="anchored" data-anchor-id="model">Model</h2>
<p>Lets create a <code>DotProdcutBias</code> model with the <code>Embedding</code>’s weights initialized as done in fastai.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># functions from fastai repository</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sigmoid_range(x, low, high):</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Sigmoid function with range `(low, high)`"</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.sigmoid(x) <span class="op">*</span> (high <span class="op">-</span> low) <span class="op">+</span> low</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> trunc_normal_(x, mean<span class="op">=</span><span class="fl">0.</span>, std<span class="op">=</span><span class="fl">1.</span>):</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Truncated normal initialization (approximation)"</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># From https://discuss.pytorch.org/t/implementing-truncated-normal-initializer/4778/12</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x.normal_().fmod_(<span class="dv">2</span>).mul_(std).add_(mean)</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Embedding(nn.Embedding):</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Embedding layer with truncated normal initialization"</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, ni, nf, std<span class="op">=</span><span class="fl">0.01</span>):</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(ni, nf)</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>        trunc_normal_(<span class="va">self</span>.weight.data, std<span class="op">=</span>std)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DotProductBias(nn.Module):</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_users, n_movies, n_factors, y_range<span class="op">=</span>(<span class="dv">0</span>, <span class="fl">5.5</span>)):</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.user_factors <span class="op">=</span> Embedding(n_users, n_factors)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.user_bias <span class="op">=</span> Embedding(n_users, <span class="dv">1</span>)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.movie_factors <span class="op">=</span> Embedding(n_movies, n_factors)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.movie_bias <span class="op">=</span> Embedding(n_movies, <span class="dv">1</span>)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.y_range <span class="op">=</span> y_range</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>        users <span class="op">=</span> <span class="va">self</span>.user_factors(x[:,<span class="dv">0</span>])</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>        movies <span class="op">=</span> <span class="va">self</span>.movie_factors(x[:,<span class="dv">1</span>])</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> (users <span class="op">*</span> movies).<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>        res <span class="op">+=</span> <span class="va">self</span>.user_bias(x[:,<span class="dv">0</span>]) <span class="op">+</span> <span class="va">self</span>.movie_bias(x[:,<span class="dv">1</span>])</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> sigmoid_range(res, <span class="op">*</span><span class="va">self</span>.y_range).flatten()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="training-with-miniai" class="level2">
<h2 class="anchored" data-anchor-id="training-with-miniai">Training with miniai</h2>
<section id="hyperparameters-set-1" class="level3">
<h3 class="anchored" data-anchor-id="hyperparameters-set-1">Hyperparameters Set # 1</h3>
<p>After playing with some hyperparameters, best results were achieved with <code>n_factors</code> equals 100.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> DotProductBias(n_users, n_items, n_factors<span class="op">=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">42</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>lr, epochs <span class="op">=</span> <span class="fl">5e-3</span>, <span class="dv">5</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>tmax <span class="op">=</span> epochs <span class="op">*</span> <span class="bu">len</span>(dls.train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>sched <span class="op">=</span> partial(lr_scheduler.OneCycleLR, max_lr<span class="op">=</span>lr, total_steps<span class="op">=</span>tmax)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> MetricsCB()</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>cbs <span class="op">=</span> [DeviceCB(), metrics, ProgressCB(plot<span class="op">=</span><span class="va">False</span>), BatchSchedCB(sched)]</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>loss_f <span class="op">=</span> nn.MSELoss()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> TrainLearner(</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    model, dls, loss_f, lr<span class="op">=</span>lr, cbs<span class="op">=</span>cbs, </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    opt_func<span class="op">=</span>partial(AdamW, weight_decay<span class="op">=</span><span class="fl">0.15</span>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>learn.fit(epochs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">loss</th>
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.908</td>
<td>0</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.706</td>
<td>0</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.692</td>
<td>1</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.691</td>
<td>1</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.656</td>
<td>2</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.654</td>
<td>2</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.586</td>
<td>3</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.603</td>
<td>3</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.471</td>
<td>4</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.591</td>
<td>4</td>
<td>eval</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="hyperparameters-set-2" class="level3">
<h3 class="anchored" data-anchor-id="hyperparameters-set-2">Hyperparameters Set # 2</h3>
<p>Similar results were achieved by increasing the batch size and with <code>n_factor</code> equals 60.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>bs <span class="op">=</span> <span class="dv">64</span> <span class="op">*</span> <span class="dv">200</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>t_sampler <span class="op">=</span> BatchSampler(</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    RandomSampler(t_dataset),</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>bs, drop_last<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>v_sampler <span class="op">=</span> BatchSampler(</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    RandomSampler(v_dataset),</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>bs<span class="op">*</span><span class="dv">2</span>, drop_last<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="ss">f"Number of batches: </span><span class="sc">{</span><span class="bu">len</span>(t_sampler)<span class="sc">:,}</span><span class="ss">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'Number of batches: 1,250'</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>t_dataloader <span class="op">=</span> DataLoader(t_dataset, sampler<span class="op">=</span>t_sampler, batch_size<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>v_dataloader <span class="op">=</span> DataLoader(v_dataset, sampler<span class="op">=</span>v_sampler, batch_size<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> DataLoaders(t_dataloader, v_dataloader)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> DotProductBias(n_users, n_items, n_factors<span class="op">=</span><span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">42</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>lr, epochs <span class="op">=</span> <span class="fl">5e-3</span>, <span class="dv">5</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>tmax <span class="op">=</span> epochs <span class="op">*</span> <span class="bu">len</span>(dls.train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>sched <span class="op">=</span> partial(lr_scheduler.OneCycleLR, max_lr<span class="op">=</span>lr, total_steps<span class="op">=</span>tmax)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> MetricsCB()</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>cbs <span class="op">=</span> [DeviceCB(), metrics, ProgressCB(plot<span class="op">=</span><span class="va">False</span>), BatchSchedCB(sched)]</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>loss_f <span class="op">=</span> nn.MSELoss()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> TrainLearner(</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    model, dls, loss_f, lr<span class="op">=</span>lr, cbs<span class="op">=</span>cbs, </span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    opt_func<span class="op">=</span>partial(AdamW, weight_decay<span class="op">=</span><span class="fl">0.15</span>)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>learn.fit(epochs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">loss</th>
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1.027</td>
<td>0</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.705</td>
<td>0</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.655</td>
<td>1</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.634</td>
<td>1</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.564</td>
<td>2</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.604</td>
<td>2</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.472</td>
<td>3</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.593</td>
<td>3</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.399</td>
<td>4</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.594</td>
<td>4</td>
<td>eval</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="recommend-movies-to-users" class="level2">
<h2 class="anchored" data-anchor-id="recommend-movies-to-users">Recommend movies to users</h2>
<p>We now have a model that can predict user ratings of a movie because it learned latent factors (implicit features) about all users and movies in the dataset. Let’s take, for example, the user <code>user_id=1</code> and create an input array of the user index and all possible movie indices.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>user_id <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>all_movies_idx <span class="op">=</span> np.arange(<span class="dv">0</span>, n_items)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>user_array <span class="op">=</span> np.full((n_items, <span class="dv">2</span>), u2uidx[user_id])</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>user_array[:, <span class="dv">1</span>] <span class="op">=</span> all_movies_idx</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>user_array</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array([[    0,     0],
       [    0,     1],
       [    0,     2],
       ...,
       [    0, 26741],
       [    0, 26742],
       [    0, 26743]])</code></pre>
</div>
</div>
<p>Or better yet, lets define a function to recommend to any user we want:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>device<span class="op">=</span>torch.device(<span class="st">"cuda:0"</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="co">#device=torch.device("cpu")</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> recommend(user_id<span class="op">=</span><span class="dv">1</span>, n_items<span class="op">=</span><span class="dv">100</span>, k<span class="op">=</span><span class="dv">10</span>, device<span class="op">=</span>device, df<span class="op">=</span>ratings_20m):</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Recommend movies the user haven't rated</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>    all_movies_idx <span class="op">=</span> np.arange(<span class="dv">0</span>, n_items)</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>    user_array <span class="op">=</span> np.full((n_items, <span class="dv">2</span>), u2uidx[user_id])</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>    user_array[:, <span class="dv">1</span>] <span class="op">=</span> all_movies_idx</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>    i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> learn.model(torch.tensor(user_array).to(device))</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>    top_indices <span class="op">=</span> preds.argsort(descending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># movies that user already rated</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>    items_rated_by_user <span class="op">=</span> df[df.user_id<span class="op">==</span>user_id].item_id.values</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'User with id=</span><span class="sc">{</span>user_id<span class="sc">}</span><span class="ss"> would likely like:'</span>)</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span><span class="st">"Rating"</span><span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span><span class="st">"Movie"</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> iidx <span class="kw">in</span> top_indices:</span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print titles the user haven't rated</span></span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> iidx2i[iidx.item()] <span class="kw">not</span> <span class="kw">in</span> items_rated_by_user:</span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>preds[iidx]<span class="sc">:&gt;6.2f}</span><span class="ss"> - </span><span class="sc">{</span>iidx2title(iidx.item())<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>            i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">&gt;=</span> k: <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>recommend(user_id<span class="op">=</span><span class="dv">1</span>, n_items<span class="op">=</span>n_items)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>User with id=1 would likely like:
Rating - Movie
  4.26 - Hobbit: An Unexpected Journey, The (2012)
  4.22 - Star Wars: Episode VI - Return of the Jedi (1983)
  4.21 - X-Men (2000)
  4.18 - Dark Knight, The (2008)
  4.18 - Spider-Man (2002)
  4.17 - Star Trek (2009)
  4.17 - Indiana Jones and the Temple of Doom (1984)
  4.13 - Hobbit: The Desolation of Smaug, The (2013)
  4.12 - Avengers, The (2012)
  4.12 - Gladiator (2000)</code></pre>
</div>
</div>
<p>And user with id 50:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>recommend(user_id<span class="op">=</span><span class="dv">50</span>, n_items<span class="op">=</span>n_items)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>User with id=50 would likely like:
Rating - Movie
  4.69 - Princess Bride, The (1987)
  4.68 - Three Colors: Red (Trois couleurs: Rouge) (1994)
  4.65 - Big Lebowski, The (1998)
  4.57 - Breakfast Club, The (1985)
  4.56 - Cosmos (1980)
  4.56 - My Neighbor Totoro (Tonari no Totoro) (1988)
  4.55 - Royal Tenenbaums, The (2001)
  4.55 - Inglourious Basterds (2009)
  4.54 - Star Wars: Episode V - The Empire Strikes Back (1980)
  4.53 - Three Colors: Blue (Trois couleurs: Bleu) (1993)</code></pre>
</div>
</div>
</section>
<section id="interpreting-results" class="level2">
<h2 class="anchored" data-anchor-id="interpreting-results">Interpreting Results</h2>
<p>For a comprehensive discussion about interpreting Embeddings (Factors) and Bias please refer to <a href="https://www.kaggle.com/code/jhoward/collaborative-filtering-deep-dive#Interpreting-Embeddings-and-Biases">Kaggle: Collaborative Filtering Deep Dive</a>.</p>
<section id="bias" class="level3">
<h3 class="anchored" data-anchor-id="bias">Bias</h3>
<p>Movies with the lowest values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>movie_bias <span class="op">=</span> learn.model.movie_bias.weight.squeeze()</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> movie_bias.argsort()[:<span class="dv">5</span>]</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>[iidx2title(i.item()) <span class="cf">for</span> i <span class="kw">in</span> idxs]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['SuperBabies: Baby Geniuses 2 (2004)',
 'From Justin to Kelly (2003)',
 'Glitter (2001)',
 "Barney's Great Adventure (1998)",
 'Gigli (2003)']</code></pre>
</div>
</div>
<p>Movies with the highest bias:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> movie_bias.argsort(descending<span class="op">=</span><span class="va">True</span>)[:<span class="dv">5</span>]</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>[iidx2title(i.item()) <span class="cf">for</span> i <span class="kw">in</span> idxs]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['Shawshank Redemption, The (1994)',
 "Schindler's List (1993)",
 'Usual Suspects, The (1995)',
 'Godfather, The (1972)',
 'Raiders of the Lost Ark (Indiana Jones and the Raiders of the Lost Ark) (1981)']</code></pre>
</div>
</div>
<p>The higher the bias of the movie means that even people that is not a good match for those movies like ‘The Usual Suspects’ or ‘The Godfather’, tends to give them a good rating.</p>
</section>
</section>
<section id="embeddings" class="level2">
<h2 class="anchored" data-anchor-id="embeddings">Embeddings</h2>
<section id="popular-movies" class="level3">
<h3 class="anchored" data-anchor-id="popular-movies">Popular Movies</h3>
<p>Lets define popular movies as movies with more than 100 ratings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>n_ratings <span class="op">=</span> ratings_20m.groupby(<span class="st">'item_id'</span>)[<span class="st">'rating'</span>].count()</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>pop_movies_df <span class="op">=</span> movies_20m.merge(</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    n_ratings, left_on<span class="op">=</span><span class="st">'item_id'</span>, right_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>pop_movies_df.columns <span class="op">=</span> [<span class="st">'item_id'</span>, <span class="st">'title'</span>, <span class="st">'genres'</span>, <span class="st">'n_ratings'</span>]</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>pop_movies_df <span class="op">=</span> pop_movies_df[pop_movies_df.n_ratings <span class="op">&gt;=</span> <span class="dv">100</span>]</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>pop_movies_df <span class="op">=</span> pop_movies_df.sort_values(</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    by<span class="op">=</span>[<span class="st">'n_ratings'</span>, <span class="st">'item_id'</span>], ascending<span class="op">=</span>(<span class="va">False</span>, <span class="va">True</span>))</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>pop_movies_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">genres</th>
<th data-quarto-table-cell-role="th">n_ratings</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">293</td>
<td>296</td>
<td>Pulp Fiction (1994)</td>
<td>Comedy|Crime|Drama|Thriller</td>
<td>67310</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">352</td>
<td>356</td>
<td>Forrest Gump (1994)</td>
<td>Comedy|Drama|Romance|War</td>
<td>66172</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">315</td>
<td>318</td>
<td>Shawshank Redemption, The (1994)</td>
<td>Crime|Drama</td>
<td>63366</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">587</td>
<td>593</td>
<td>Silence of the Lambs, The (1991)</td>
<td>Crime|Horror|Thriller</td>
<td>63299</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">476</td>
<td>480</td>
<td>Jurassic Park (1993)</td>
<td>Action|Adventure|Sci-Fi|Thriller</td>
<td>59715</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12271</td>
<td>56336</td>
<td>Wrong Turn 2: Dead End (2007)</td>
<td>Action|Horror|Thriller</td>
<td>100</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12722</td>
<td>59915</td>
<td>Stuck (2007)</td>
<td>Horror|Thriller</td>
<td>100</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14350</td>
<td>71878</td>
<td>Stepfather, The (2009)</td>
<td>Horror|Thriller</td>
<td>100</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15860</td>
<td>80469</td>
<td>Superman/Batman: Apocalypse (2010)</td>
<td>Animation</td>
<td>100</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">23754</td>
<td>112911</td>
<td>Hercules (2014)</td>
<td>Action|Adventure</td>
<td>100</td>
</tr>
</tbody>
</table>

<p>8546 rows × 4 columns</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>pop_movies_id <span class="op">=</span> pop_movies_df.item_id</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="co"># item_id to dataloader's item index</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>pop_movies_idx <span class="op">=</span> np.array([i2iidx[<span class="bu">id</span>] <span class="cf">for</span> <span class="bu">id</span> <span class="kw">in</span> pop_movies_id])</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a><span class="co"># item index to titles</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>pop_movies_title <span class="op">=</span> np.array([iidx2title(idx.item()) <span class="cf">for</span> idx <span class="kw">in</span> pop_movies_idx])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="popular-movies-embeddings" class="level3">
<h3 class="anchored" data-anchor-id="popular-movies-embeddings">Popular movies embeddings</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>pop_movies_emb <span class="op">=</span> learn.model.movie_factors.weight[pop_movies_idx].cpu().detach()</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>pop_movies_emb.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([8546, 60])</code></pre>
</div>
</div>
<p>The embeddings are a vector of size 60.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>pop_movies_emb[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([-0.2493,  0.3020,  0.9561,  0.5596,  0.7226,  0.3335, -0.3435,  0.0695,
         0.4565, -0.3386, -0.4577, -1.2690, -0.1703, -0.4787, -0.4197,  0.8845,
        -0.5262, -0.3538,  0.4294,  0.6587,  0.0867,  0.2583,  0.2544, -0.8050,
         0.4216, -0.8228,  0.5268,  0.6913,  0.3080, -1.0402,  0.2570,  0.3762,
         0.0897, -0.7355,  0.6587, -0.2353, -1.2990, -0.7492,  1.0346,  0.5964,
         0.7656, -0.0978,  0.3987,  0.4051, -0.1287,  0.6400, -0.6192,  1.2921,
        -0.5318,  0.6024, -0.7220, -0.5899, -0.7019,  0.5004, -0.2944, -0.5028,
        -0.2923, -0.0144, -0.4991,  0.2179])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="bu">all</span>(pop_movies_title<span class="op">==</span>pop_movies_df.title.values)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>True</code></pre>
</div>
</div>
</section>
</section>
<section id="visualizing-the-embeddings" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-the-embeddings">Visualizing the embeddings</h2>
<section id="dimensionality-reduction-pca" class="level3">
<h3 class="anchored" data-anchor-id="dimensionality-reduction-pca">Dimensionality reduction: PCA</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># from fastai library</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pca(x:torch.tensor, k<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Compute PCA of `x` with `k` dimensions."</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> x<span class="op">-</span>torch.mean(x,<span class="dv">0</span>)</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>    U,S,V <span class="op">=</span> torch.svd(x.t())</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.mm(x,U[:,:k])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>movie_pca <span class="op">=</span> pca(pop_movies_emb, <span class="dv">3</span>)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>fac0, fac1, fac2 <span class="op">=</span> movie_pca.t()</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">30</span>))</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>X_pca <span class="op">=</span> fac0</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>Y_pca <span class="op">=</span> fac2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>pop_movies_df[<span class="st">'x_pca'</span>] <span class="op">=</span> X_pca</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>pop_movies_df[<span class="st">'y_pca'</span>] <span class="op">=</span> Y_pca</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dimensionality-reduction-t-sne" class="level3">
<h3 class="anchored" data-anchor-id="dimensionality-reduction-t-sne">Dimensionality reduction: t-SNE</h3>
<p><a href="https://www.kaggle.com/code/colinmorris/visualizing-embeddings-with-t-sne">Kaggle: Visualizing Embeddings With t-SNE</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.manifold <span class="im">import</span> TSNE</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>tsne <span class="op">=</span> TSNE(random_state<span class="op">=</span><span class="dv">1</span>, n_iter<span class="op">=</span><span class="dv">1_500</span>, metric<span class="op">=</span><span class="st">"cosine"</span>)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>movie_tsne <span class="op">=</span> tsne.fit_transform(</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    pop_movies_emb</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/fmussari/mambaforge/envs/fastaiv3/lib/python3.9/site-packages/sklearn/manifold/_t_sne.py:780: FutureWarning: The default initialization in TSNE will change from 'random' to 'pca' in 1.2.
  warnings.warn(
/home/fmussari/mambaforge/envs/fastaiv3/lib/python3.9/site-packages/sklearn/manifold/_t_sne.py:790: FutureWarning: The default learning rate in TSNE will change from 200.0 to 'auto' in 1.2.
  warnings.warn(
/home/fmussari/mambaforge/envs/fastaiv3/lib/python3.9/site-packages/sklearn/manifold/_t_sne.py:819: FutureWarning: 'square_distances' has been introduced in 0.24 to help phase out legacy squaring behavior. The 'legacy' setting will be removed in 1.1 (renaming of 0.26), and the default setting will be changed to True. In 1.3, 'square_distances' will be removed altogether, and distances will be squared by default. Set 'square_distances'=True to silence this warning.
  warnings.warn(</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>pop_movies_df[<span class="st">'x'</span>] <span class="op">=</span> movie_tsne[:, <span class="dv">0</span>]</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>pop_movies_df[<span class="st">'y'</span>] <span class="op">=</span> movie_tsne[:, <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="helper-functions" class="level3">
<h3 class="anchored" data-anchor-id="helper-functions">Helper functions</h3>
<p>These functions are a simplification of those in the aforementioned Kaggle notebook.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_bg(df, x<span class="op">=</span><span class="st">'x'</span>, y<span class="op">=</span><span class="st">'y'</span>, bg_alpha<span class="op">=</span><span class="fl">.01</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>)):</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create and return a plot of all movie embeddings with very low opacity.</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>figsize)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    ax.scatter(df[x], df[y], alpha<span class="op">=</span>bg_alpha)</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_by_title_pattern(df, pattern, x<span class="op">=</span><span class="st">'x'</span>, y<span class="op">=</span><span class="st">'y'</span>):</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot all movies whose titles match the given regex pattern.</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>    match <span class="op">=</span> df[df.title.<span class="bu">str</span>.contains(pattern)]</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> plot_with_annotations(df, match.index, x<span class="op">=</span>x, y<span class="op">=</span>y)</span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_list_of_values(df, list_of_values, column<span class="op">=</span><span class="st">'item_id'</span>):</span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot all movies whose "column" values are in list_of_values.</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>    match <span class="op">=</span> df[df[column].isin(list_of_values)]</span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> plot_with_annotations(df, match.index)</span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_with_annotations(df, label_indices, x<span class="op">=</span><span class="st">'x'</span>, y<span class="op">=</span><span class="st">'y'</span>):</span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a plot of all movie embeddings with very low opacity and</span></span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a><span class="co">    highlight values whose indices are in in label_indices.</span></span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> plot_bg(df, x<span class="op">=</span>x, y<span class="op">=</span>y)</span>
<span id="cb102-25"><a href="#cb102-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Highlighting </span><span class="sc">{</span><span class="bu">len</span>(label_indices)<span class="sc">}</span><span class="ss"> items'</span>)</span>
<span id="cb102-26"><a href="#cb102-26" aria-hidden="true" tabindex="-1"></a>    Xlabeled <span class="op">=</span> df[x].loc[label_indices]</span>
<span id="cb102-27"><a href="#cb102-27" aria-hidden="true" tabindex="-1"></a>    Ylabeled <span class="op">=</span> df[y].loc[label_indices]</span>
<span id="cb102-28"><a href="#cb102-28" aria-hidden="true" tabindex="-1"></a>    ax.scatter(Xlabeled, Ylabeled, alpha<span class="op">=</span><span class="fl">0.5</span>, color<span class="op">=</span><span class="st">'green'</span>)</span>
<span id="cb102-29"><a href="#cb102-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-30"><a href="#cb102-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span>
<span id="cb102-31"><a href="#cb102-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-32"><a href="#cb102-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_region_around(df, title, margin<span class="op">=</span><span class="dv">5</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>)):</span>
<span id="cb102-33"><a href="#cb102-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot the region of the mapping space bounded by the given x and y limits.</span></span>
<span id="cb102-34"><a href="#cb102-34" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb102-35"><a href="#cb102-35" aria-hidden="true" tabindex="-1"></a>    xmargin <span class="op">=</span> ymargin <span class="op">=</span> margin</span>
<span id="cb102-36"><a href="#cb102-36" aria-hidden="true" tabindex="-1"></a>    match <span class="op">=</span> df[df.title <span class="op">==</span> title]</span>
<span id="cb102-37"><a href="#cb102-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(match) <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb102-38"><a href="#cb102-38" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> match.iloc[<span class="dv">0</span>]</span>
<span id="cb102-39"><a href="#cb102-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> plot_region(</span>
<span id="cb102-40"><a href="#cb102-40" aria-hidden="true" tabindex="-1"></a>        df, row.x<span class="op">-</span>xmargin, row.x<span class="op">+</span>xmargin, row.y<span class="op">-</span>ymargin, row.y<span class="op">+</span>ymargin)</span>
<span id="cb102-41"><a href="#cb102-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-42"><a href="#cb102-42" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_region(df, x0, x1, y0, y1, text<span class="op">=</span><span class="va">True</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>)):</span>
<span id="cb102-43"><a href="#cb102-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot the region of the mapping space bounded by the given x and y limits.</span></span>
<span id="cb102-44"><a href="#cb102-44" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb102-45"><a href="#cb102-45" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>figsize)</span>
<span id="cb102-46"><a href="#cb102-46" aria-hidden="true" tabindex="-1"></a>    limits <span class="op">=</span> (</span>
<span id="cb102-47"><a href="#cb102-47" aria-hidden="true" tabindex="-1"></a>        (df.x <span class="op">&gt;=</span> x0) <span class="op">&amp;</span> (df.x <span class="op">&lt;=</span> x1) <span class="op">&amp;</span> (df.y <span class="op">&gt;=</span> y0) <span class="op">&amp;</span> (df.y <span class="op">&lt;=</span> y1))</span>
<span id="cb102-48"><a href="#cb102-48" aria-hidden="true" tabindex="-1"></a>    pts <span class="op">=</span> df[limits]</span>
<span id="cb102-49"><a href="#cb102-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Showing </span><span class="sc">{</span><span class="bu">sum</span>(limits)<span class="sc">}</span><span class="ss"> items"</span>)</span>
<span id="cb102-50"><a href="#cb102-50" aria-hidden="true" tabindex="-1"></a>    ax.scatter(pts.x, pts.y, alpha<span class="op">=</span><span class="fl">.6</span>)</span>
<span id="cb102-51"><a href="#cb102-51" aria-hidden="true" tabindex="-1"></a>    ax.set_xlim(x0, x1)</span>
<span id="cb102-52"><a href="#cb102-52" aria-hidden="true" tabindex="-1"></a>    ax.set_ylim(y0, y1)</span>
<span id="cb102-53"><a href="#cb102-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> text:</span>
<span id="cb102-54"><a href="#cb102-54" aria-hidden="true" tabindex="-1"></a>        texts <span class="op">=</span> []</span>
<span id="cb102-55"><a href="#cb102-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> label, x, y <span class="kw">in</span> <span class="bu">zip</span>(pts.title.values, pts.x.values, pts.y.values):</span>
<span id="cb102-56"><a href="#cb102-56" aria-hidden="true" tabindex="-1"></a>            t <span class="op">=</span> ax.annotate(label, xy<span class="op">=</span>(x, y))</span>
<span id="cb102-57"><a href="#cb102-57" aria-hidden="true" tabindex="-1"></a>            texts.append(t)</span>
<span id="cb102-58"><a href="#cb102-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pca" class="level3">
<h3 class="anchored" data-anchor-id="pca">PCA</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>plot_bg(df<span class="op">=</span>pop_movies_df, x<span class="op">=</span><span class="st">'x_pca'</span>, y<span class="op">=</span><span class="st">'y_pca'</span>, bg_alpha<span class="op">=</span><span class="fl">.05</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07_MovieLens_20M_Part1_files/figure-html/cell-78-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="t-sne" class="level3">
<h3 class="anchored" data-anchor-id="t-sne">t-SNE</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>plot_bg(df<span class="op">=</span>pop_movies_df, x<span class="op">=</span><span class="st">'x'</span>, y<span class="op">=</span><span class="st">'y'</span>, bg_alpha<span class="op">=</span><span class="fl">.05</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-07_MovieLens_20M_Part1_files/figure-html/cell-79-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="highlight-movies" class="level3">
<h3 class="anchored" data-anchor-id="highlight-movies">Highlight movies</h3>
<p>Remember that the model only had <code>user_id</code>, <code>item_id</code> and <code>ratings</code> as features. All relations and patterns that we are going to see from now on were learned as latent factor only from the interaction between users and movies. With no data about movies or users themselves.</p>
<section id="harry-potter" class="level4">
<h4 class="anchored" data-anchor-id="harry-potter">Harry Potter</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>plot_by_title_pattern(pop_movies_df, <span class="st">'Harry Potter'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Highlighting 8 items</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-07_MovieLens_20M_Part1_files/figure-html/cell-80-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>The 8 Harry Potter movies are so close that are almost indistinguishable in the plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>pop_movies_df[pop_movies_df.title.<span class="bu">str</span>.contains(<span class="st">'Harry Potter'</span>)][[<span class="st">'item_id'</span>, <span class="st">'title'</span>, <span class="st">'x'</span>, <span class="st">'y'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">x</th>
<th data-quarto-table-cell-role="th">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">4800</td>
<td>4896</td>
<td>Harry Potter and the Sorcerer's Stone (a.k.a. ...</td>
<td>-88.674049</td>
<td>4.128831</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5717</td>
<td>5816</td>
<td>Harry Potter and the Chamber of Secrets (2002)</td>
<td>-88.672592</td>
<td>4.128721</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">7769</td>
<td>8368</td>
<td>Harry Potter and the Prisoner of Azkaban (2004)</td>
<td>-88.670090</td>
<td>4.129076</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">10600</td>
<td>40815</td>
<td>Harry Potter and the Goblet of Fire (2005)</td>
<td>-88.668808</td>
<td>4.128649</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">11974</td>
<td>54001</td>
<td>Harry Potter and the Order of the Phoenix (2007)</td>
<td>-88.666321</td>
<td>4.128205</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13935</td>
<td>69844</td>
<td>Harry Potter and the Half-Blood Prince (2009)</td>
<td>-88.664932</td>
<td>4.127958</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">17499</td>
<td>88125</td>
<td>Harry Potter and the Deathly Hallows: Part 2 (...</td>
<td>-88.660225</td>
<td>4.126957</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">16191</td>
<td>81834</td>
<td>Harry Potter and the Deathly Hallows: Part 1 (...</td>
<td>-88.659821</td>
<td>4.126904</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>plot_region_around(</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>    pop_movies_df, <span class="st">'Harry Potter and the Order of the Phoenix (2007)'</span>, margin<span class="op">=</span><span class="fl">0.008</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Showing 8 items</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-07_MovieLens_20M_Part1_files/figure-html/cell-82-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>By looking at the axis scale, we can see that they are very, very close. Impressive.</p>
</section>
<section id="star-wars" class="level4">
<h4 class="anchored" data-anchor-id="star-wars">Star Wars</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>pop_movies_df[pop_movies_df.title.<span class="bu">str</span>.contains(<span class="st">'Star Wars'</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">genres</th>
<th data-quarto-table-cell-role="th">n_ratings</th>
<th data-quarto-table-cell-role="th">x_pca</th>
<th data-quarto-table-cell-role="th">y_pca</th>
<th data-quarto-table-cell-role="th">x</th>
<th data-quarto-table-cell-role="th">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">257</td>
<td>260</td>
<td>Star Wars: Episode IV - A New Hope (1977)</td>
<td>Action|Adventure|Sci-Fi</td>
<td>54502</td>
<td>-0.246074</td>
<td>-0.417709</td>
<td>-70.578560</td>
<td>13.257028</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1184</td>
<td>1210</td>
<td>Star Wars: Episode VI - Return of the Jedi (1983)</td>
<td>Action|Adventure|Sci-Fi</td>
<td>46839</td>
<td>0.144319</td>
<td>-0.921739</td>
<td>-70.577507</td>
<td>13.240388</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1171</td>
<td>1196</td>
<td>Star Wars: Episode V - The Empire Strikes Back...</td>
<td>Action|Adventure|Sci-Fi</td>
<td>45313</td>
<td>-0.387326</td>
<td>-0.676300</td>
<td>-70.583687</td>
<td>13.270293</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2543</td>
<td>2628</td>
<td>Star Wars: Episode I - The Phantom Menace (1999)</td>
<td>Action|Adventure|Sci-Fi</td>
<td>29574</td>
<td>0.924800</td>
<td>-0.526612</td>
<td>-70.411499</td>
<td>10.423186</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5281</td>
<td>5378</td>
<td>Star Wars: Episode II - Attack of the Clones (...</td>
<td>Action|Adventure|Sci-Fi|IMAX</td>
<td>16425</td>
<td>0.776779</td>
<td>-0.675660</td>
<td>-70.408615</td>
<td>10.422228</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">10117</td>
<td>33493</td>
<td>Star Wars: Episode III - Revenge of the Sith (...</td>
<td>Action|Adventure|Sci-Fi</td>
<td>12303</td>
<td>0.525108</td>
<td>-0.795317</td>
<td>-70.412682</td>
<td>10.452327</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12926</td>
<td>61160</td>
<td>Star Wars: The Clone Wars (2008)</td>
<td>Action|Adventure|Animation|Sci-Fi</td>
<td>843</td>
<td>0.652965</td>
<td>-0.284741</td>
<td>-70.394539</td>
<td>10.364397</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>plot_by_title_pattern(pop_movies_df, <span class="st">'Star Wars'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Highlighting 7 items</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-07_MovieLens_20M_Part1_files/figure-html/cell-84-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>plot_region_around(</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>    pop_movies_df, <span class="st">'Star Wars: Episode I - The Phantom Menace (1999)'</span>, margin<span class="op">=</span><span class="fl">0.06</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Showing 4 items</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-07_MovieLens_20M_Part1_files/figure-html/cell-85-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>plot_region_around(</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>    pop_movies_df, <span class="st">'Star Wars: Episode IV - A New Hope (1977)'</span>, margin<span class="op">=</span><span class="fl">0.06</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Showing 3 items</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-07_MovieLens_20M_Part1_files/figure-html/cell-86-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>That’s impressive, isn’t it? There are two clusters that at the same time are close. One cluster is for the ones released in the 1980s (original trilogy), and the other for the ones released after 1999. It is as if the years were a model’s feature.</p>
</section>
<section id="godfather" class="level4">
<h4 class="anchored" data-anchor-id="godfather">Godfather</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>pop_movies_df[pop_movies_df.title.<span class="bu">str</span>.contains(<span class="st">'Godfather'</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">genres</th>
<th data-quarto-table-cell-role="th">n_ratings</th>
<th data-quarto-table-cell-role="th">x_pca</th>
<th data-quarto-table-cell-role="th">y_pca</th>
<th data-quarto-table-cell-role="th">x</th>
<th data-quarto-table-cell-role="th">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">843</td>
<td>858</td>
<td>Godfather, The (1972)</td>
<td>Crime|Drama</td>
<td>41355</td>
<td>-1.144734</td>
<td>-0.149714</td>
<td>-0.402252</td>
<td>66.513908</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1195</td>
<td>1221</td>
<td>Godfather: Part II, The (1974)</td>
<td>Crime|Drama</td>
<td>27398</td>
<td>-1.063627</td>
<td>-0.211216</td>
<td>-0.408337</td>
<td>66.517693</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1939</td>
<td>2023</td>
<td>Godfather: Part III, The (1990)</td>
<td>Crime|Drama|Mystery|Thriller</td>
<td>10141</td>
<td>0.094486</td>
<td>-0.535812</td>
<td>71.090759</td>
<td>54.931854</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7924</td>
<td>8607</td>
<td>Tokyo Godfathers (2003)</td>
<td>Adventure|Animation|Drama</td>
<td>705</td>
<td>-0.615767</td>
<td>-0.214817</td>
<td>43.958630</td>
<td>21.984804</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>list_of_item_ids <span class="op">=</span> [<span class="dv">858</span>, <span class="dv">1221</span>, <span class="dv">2023</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>plot_list_of_values(pop_movies_df, list_of_item_ids, column<span class="op">=</span><span class="st">'item_id'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Highlighting 3 items</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-07_MovieLens_20M_Part1_files/figure-html/cell-89-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>plot_region_around(pop_movies_df, <span class="st">'Godfather, The (1972)'</span>, margin<span class="op">=</span><span class="fl">0.1</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Showing 2 items</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-07_MovieLens_20M_Part1_files/figure-html/cell-90-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>The two of them released in the 1970s were very close.</p>
</section>
<section id="toy-story" class="level4">
<h4 class="anchored" data-anchor-id="toy-story">Toy Story</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>pop_movies_df[pop_movies_df.title.<span class="bu">str</span>.contains(<span class="st">'Toy Story'</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">item_id</th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">genres</th>
<th data-quarto-table-cell-role="th">n_ratings</th>
<th data-quarto-table-cell-role="th">x_pca</th>
<th data-quarto-table-cell-role="th">y_pca</th>
<th data-quarto-table-cell-role="th">x</th>
<th data-quarto-table-cell-role="th">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>Toy Story (1995)</td>
<td>Adventure|Animation|Children|Comedy|Fantasy</td>
<td>49695</td>
<td>-0.146245</td>
<td>0.237802</td>
<td>24.761007</td>
<td>-54.195663</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3027</td>
<td>3114</td>
<td>Toy Story 2 (1999)</td>
<td>Adventure|Animation|Children|Comedy|Fantasy</td>
<td>22770</td>
<td>-0.209496</td>
<td>0.377863</td>
<td>24.759005</td>
<td>-54.147175</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">15401</td>
<td>78499</td>
<td>Toy Story 3 (2010)</td>
<td>Adventure|Animation|Children|Comedy|Fantasy|IMAX</td>
<td>5781</td>
<td>-0.242506</td>
<td>-0.096230</td>
<td>24.653181</td>
<td>-53.001858</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>plot_by_title_pattern(pop_movies_df, <span class="st">'Toy Story'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Highlighting 3 items</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-07_MovieLens_20M_Part1_files/figure-html/cell-92-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>plot_region_around(pop_movies_df, <span class="st">'Toy Story 3 (2010)'</span>, margin<span class="op">=</span><span class="fl">1.25</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Showing 9 items</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-07_MovieLens_20M_Part1_files/figure-html/cell-93-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>The two of them released in the 1990s are very close. The one released in 2010 is also near. And in the surroundings we can see more Pixar movies. The model clustered almost perfectly Pixar movies that won the Oscars.</p>
</section>
</section>
</section>
<section id="highlight-genres" class="level2">
<h2 class="anchored" data-anchor-id="highlight-genres">Highlight genres</h2>
<section id="documentary" class="level3">
<h3 class="anchored" data-anchor-id="documentary">Documentary</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>docs <span class="op">=</span> pop_movies_df[(pop_movies_df.genres <span class="op">==</span> <span class="st">'Documentary'</span>)]</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>plot_with_annotations(pop_movies_df, docs.index)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Highlighting 242 items</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-07_MovieLens_20M_Part1_files/figure-html/cell-94-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="horror" class="level3">
<h3 class="anchored" data-anchor-id="horror">Horror</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>docs <span class="op">=</span> pop_movies_df[(pop_movies_df.genres <span class="op">==</span> <span class="st">'Horror'</span>)]</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>plot_with_annotations(pop_movies_df, docs.index)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Highlighting 156 items</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-07_MovieLens_20M_Part1_files/figure-html/cell-95-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>There is definitely some clustering happening.</p>
</section>
</section>
<section id="find-similar-movies" class="level2">
<h2 class="anchored" data-anchor-id="find-similar-movies">Find similar movies</h2>
<p>The blog post <a href="https://wasimlorgat.com/posts/image-vector-search.html">Building a cost-effective image vector search engine with CLIP</a> teaches us, among other things, how to calculate cosine similarity and find the nearest vector from a given one. This allows us to find movies that are similar to a given movie according to the embeddings our model has learned.</p>
<p>Lets first define some functions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalize(a): <span class="cf">return</span> a <span class="op">/</span> a.norm(dim<span class="op">=-</span><span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cosine_sim(a, b): <span class="cf">return</span> normalize(a) <span class="op">@</span> normalize(b).T</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> search(embs, query_embs):</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>    sims <span class="op">=</span> cosine_sim(embs, query_embs).flatten()</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>    indices <span class="op">=</span> sims.argsort(descending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> indices, sims[indices]</span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> most_similar_by_idx(items_emb, idx, k<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>    indices, sim <span class="op">=</span> search(items_emb, items_emb[idx])</span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Movies similar to:</span><span class="ch">\n</span><span class="ss">"</span><span class="sc">{</span>pop_movies_title[idx]<span class="sc">}</span><span class="ss">"'</span>)</span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'  sim - movie'</span>)</span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, idx <span class="kw">in</span> <span class="bu">enumerate</span>(indices[<span class="dv">1</span>:k<span class="op">+</span><span class="dv">1</span>]):</span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>sim[i]<span class="sc">:.3f}</span><span class="ss"> - </span><span class="sc">{</span>pop_movies_title[idx]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> most_similar_by_title(items_emb, title, k<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.where(pop_movies_title<span class="op">==</span>title)[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb132-18"><a href="#cb132-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> most_similar_by_idx(items_emb, idx, k<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb132-19"><a href="#cb132-19" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb132-20"><a href="#cb132-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> display_indices(word):</span>
<span id="cb132-21"><a href="#cb132-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span><span class="st">"index"</span><span class="sc">:&lt;5}</span><span class="ss">, titles'</span>)</span>
<span id="cb132-22"><a href="#cb132-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, title <span class="kw">in</span> <span class="bu">enumerate</span>(pop_movies_title):</span>
<span id="cb132-23"><a href="#cb132-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> word <span class="kw">in</span> title:</span>
<span id="cb132-24"><a href="#cb132-24" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>idx<span class="sc">:&gt;5}</span><span class="ss">, </span><span class="sc">{</span>title<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>title <span class="op">=</span> <span class="st">"Harry Potter and the Sorcerer's Stone (a.k.a. Harry Potter and the Philosopher's Stone) (2001)"</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>most_similar_by_title(pop_movies_emb, title<span class="op">=</span>title)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Movies similar to:
"Harry Potter and the Sorcerer's Stone (a.k.a. Harry Potter and the Philosopher's Stone) (2001)"
  sim - movie
1.000 - Harry Potter and the Chamber of Secrets (2002)
0.991 - Harry Potter and the Goblet of Fire (2005)
0.956 - Harry Potter and the Prisoner of Azkaban (2004)
0.955 - Harry Potter and the Order of the Phoenix (2007)
0.925 - Harry Potter and the Half-Blood Prince (2009)
0.907 - Harry Potter and the Deathly Hallows: Part 2 (2011)
0.881 - Harry Potter and the Deathly Hallows: Part 1 (2010)
0.862 - Hunger Games: Catching Fire, The (2013)
0.561 - Chronicles of Narnia: The Lion, the Witch and the Wardrobe, The (2005)
0.544 - Chronicles of Narnia: Prince Caspian, The (2008)</code></pre>
</div>
</div>
<p>As we saw with t-SNE, the Harry Potter films are very closely related to each other.</p>
<p>Lets try with some less popular like Half Nelson.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>most_similar_by_title(pop_movies_emb, title<span class="op">=</span><span class="st">'Half Nelson (2006)'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Movies similar to:
"Half Nelson (2006)"
  sim - movie
1.000 - Rachel Getting Married (2008)
0.786 - Requiem (2006)
0.764 - Hollow Reed (1996)
0.750 - Blue Is the Warmest Color (La vie d'Adèle) (2013)
0.749 - And Your Mother Too (Y tu mamá también) (2001)
0.748 - Squid and the Whale, The (2005)
0.743 - Upstream Color (2013)
0.739 - Calvary (2014)
0.737 - Animal Kingdom (2010)
0.735 - Three Burials of Melquiades Estrada, The (2006)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>most_similar_by_title(pop_movies_emb, title<span class="op">=</span><span class="st">'Blue Velvet (1986)'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Movies similar to:
"Blue Velvet (1986)"
  sim - movie
1.000 - Lolita (1962)
0.724 - Eraserhead (1977)
0.723 - Wild at Heart (1990)
0.711 - Mulholland Drive (2001)
0.709 - Tin Drum, The (Blechtrommel, Die) (1979)
0.704 - Aguirre: The Wrath of God (Aguirre, der Zorn Gottes) (1972)
0.698 - Videodrome (1983)
0.697 - Barton Fink (1991)
0.688 - Man Who Fell to Earth, The (1976)
0.688 - Naked Lunch (1991)</code></pre>
</div>
</div>
<p>We can see some other Lynch’s movies there and some Kubrick’s.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>most_similar_by_title(pop_movies_emb, title<span class="op">=</span><span class="st">"Full Metal Jacket (1987)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Movies similar to:
"Full Metal Jacket (1987)"
  sim - movie
1.000 - Apocalypse Now (1979)
0.740 - Platoon (1986)
0.730 - Goodfellas (1990)
0.672 - Clockwork Orange, A (1971)
0.660 - Deer Hunter, The (1978)
0.640 - Scarface (1983)
0.633 - Reservoir Dogs (1992)
0.631 - Once Upon a Time in America (1984)
0.602 - City of God (Cidade de Deus) (2002)
0.601 - Straw Dogs (1971)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>display_indices(<span class="st">'Átame'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>index, titles
 2413, Tie Me Up! Tie Me Down! (¡Átame!) (1990)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>most_similar_by_title(pop_movies_emb, title<span class="op">=</span><span class="st">"Tie Me Up! Tie Me Down! (¡Átame!) (1990)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Movies similar to:
"Tie Me Up! Tie Me Down! (¡Átame!) (1990)"
  sim - movie
1.000 - Live Flesh (Carne trémula) (1997)
0.776 - Women on the Verge of a Nervous Breakdown (Mujeres al borde de un ataque de nervios) (1988)
0.750 - Sex and Lucia (Lucía y el sexo) (2001)
0.748 - All About My Mother (Todo sobre mi madre) (1999)
0.745 - 1900 (Novecento) (1976)
0.737 - High Heels (Tacones lejanos) (1991)
0.727 - Wild Reeds (Les roseaux sauvages) (1994)
0.722 - What Have I Done to Deserve This? (¿Qué he hecho yo para merecer esto!!) (1984)
0.716 - Keep the River on Your Right: A Modern Cannibal Tale (2000)
0.716 - Thieves (Voleurs, Les) (1996)</code></pre>
</div>
</div>
<p>Mostly Almodovar´s there.</p>
<p>Remember that t-SNE placed The Godfather III far away from the other two? Well, as we can see here cosine similarity with the full embeddings place them really close.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>most_similar_by_title(pop_movies_emb, title<span class="op">=</span><span class="st">"Godfather: Part III, The (1990)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Movies similar to:
"Godfather: Part III, The (1990)"
  sim - movie
1.000 - Godfather: Part II, The (1974)
0.626 - Godfather, The (1972)
0.574 - Once Upon a Time in America (1984)
0.538 - Scent of a Woman (1992)
0.503 - Carlito's Way (1993)
0.500 - Hollywood Ending (2002)
0.482 - Scarface (1983)
0.475 - Best Offer, The (Migliore offerta, La) (2013)
0.474 - Casino Jack (2010)
0.472 - Devil's Advocate, The (1997)</code></pre>
</div>
</div>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<ul>
<li><p>It is very impressive how the model can cluster movies without knowing anything explicit about them with such a simple architecture like a DotProductBias model. It learned features that clustered movies by sagas, directors or studios.</p></li>
<li><p>For this case t-SNE was very good representing clusters in a reduced dimensionality.</p></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>